<!DOCTYPE html>
<html lang="zh-CN,en,zh-TW,default">
  <head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/tree/4.3.1'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://cdn.jsdelivr.net'>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <link rel="preload" href="/css/first.css" as="style">
  

  <!-- 页面元数据 -->
  
  <title>the-solution-of-elixir-continuous-runtime-system-code-coverage-collection - ShanSan</title>
  
    <meta name="keywords" content="run-time system test coverage">
  

  

  <!-- feed -->
  
    <link rel="alternate" href="/rss2.xml" title="ShanSan" type="application/rss+xml">
  

  <!-- import meta -->
  

  <!-- link -->
  
    <link rel="shortcut icon" type='image/x-icon' href="https://img.vim-cn.com/bb/db444be0b7fda59c69d5c64167f9668b0b66bd.png">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/first.css">

  

  
  <link rel="stylesheet" href="/css/style.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
  

  <script id="loadcss"></script>

  
<script>
if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode))
    document.write(
	'<style>'+
		'html{'+
			'overflow-x: hidden !important;'+
			'overflow-y: hidden !important;'+
		'}'+
		'.kill-ie{'+
			'text-align:center;'+
			'height: 100%;'+
			'margin-top: 15%;'+
			'margin-bottom: 5500%;'+
		'}'+
	'</style>'+
    '<div class="kill-ie">'+
        '<h1><b>抱歉，您的浏览器无法访问本站</b></h1>'+
        '<h3>微软已经于2016年终止了对 Internet Explorer (IE) 10 及更早版本的支持，<br/>'+
        '继续使用存在极大的安全隐患，请使用当代主流的浏览器进行访问。</h3><br/>'+
        '<a target="_blank" rel="noopener" href="https://www.microsoft.com/zh-cn/WindowsForBusiness/End-of-IE-support"><strong>了解详情 ></strong></a>'+
    '</div>');
</script>


<noscript>
	<style>
		html{
			overflow-x: hidden !important;
			overflow-y: hidden !important;
		}
		.kill-noscript{
			text-align:center;
			height: 100%;
			margin-top: 15%;
			margin-bottom: 5500%;
		}
	</style>
    <div class="kill-noscript">
        <h1><b>抱歉，您的浏览器无法访问本站</b></h1>
        <h3>本页面需要浏览器支持（启用）JavaScript</h3><br/>
        <a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=启用JavaScript"><strong>了解详情 ></strong></a>
    </div>
</noscript>

</head>

  <body>
    

<header id="l_header" class="l_header auto shadow blur " style='opacity: 0' >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a id="s-toc" class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
            ShanSan
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博文
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" 
                  
                  
                  >
                  <i class='fas fa-ellipsis-v fa-fw'></i>与我相关
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://github.com/yeshan333
                  
                  
                  
                    id="https:githubcomyeshan333"
                  >
                  <i class='fab fa-github-square fa-fw'></i>Github
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://slide.shan333.cn
                  
                  
                  
                    id="https:slideshan333cn"
                  >
                  <i class='fab fa-slideshare fa-fw'></i>slides
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://shansan.top/knowledge-base/
                  
                  
                  
                    id="https:shansantopknowledge-base"
                  >
                  <i class='far fa-sticky-note fa-fw'></i>notes
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://stats.uptimerobot.com/OknEPcNEVr
                  
                  
                  
                    id="https:statsuptimerobotcomOknEPcNEVr"
                  >
                  Monitor
                </a>
                
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/cloud-native/
                  
                  
                  
                    id="cloud-native"
                  >
                  <i class='fas fa-cloud fa-fw'></i>云原生
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="寻你所想" />
        </form>
      </div>

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博文
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" 
                  
                  
                  >
                  <i class='fas fa-ellipsis-v fa-fw'></i>与我相关
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://github.com/yeshan333
                  
                  
                  
                    id="https:githubcomyeshan333"
                  >
                  <i class='fab fa-github-square fa-fw'></i>Github
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://slide.shan333.cn
                  
                  
                  
                    id="https:slideshan333cn"
                  >
                  <i class='fab fa-slideshare fa-fw'></i>slides
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://shansan.top/knowledge-base/
                  
                  
                  
                    id="https:shansantopknowledge-base"
                  >
                  <i class='far fa-sticky-note fa-fw'></i>notes
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=https://stats.uptimerobot.com/OknEPcNEVr
                  
                  
                  
                    id="https:statsuptimerobotcomOknEPcNEVr"
                  >
                  Monitor
                </a>
                
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/cloud-native/
                  
                  
                  
                    id="cloud-native"
                  >
                  <i class='fas fa-cloud fa-fw'></i>云原生
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

    <div id="l_body">
      <div id="l_cover">
  
      
  
  </div>

      <div id="safearea">
        <div class="body-wrapper" id="pjax-container">
          

<div class='l_main'>
  <article class="article post white-box reveal md shadow article-type-post" id="post" itemscope itemprop="blogPost">
  


  
    <div class='headimg-div'>
      <a class='headimg-a'>
        <img class='headimg' src='https://res.cloudinary.com/practicaldev/image/fetch/s--Q6M7xD6i--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/x1b2td0z0mg6hrq2ljy5.png'/>
      </a>
    </div>
  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title">
        the-solution-of-elixir-continuous-runtime-system-code-coverage-collection
      </h1>
      <div class='new-meta-box'>
        
          
            
<div class='new-meta-item author'>
  <a class='author' target="_blank" href="https://github.com/yeshan333" rel="nofollow noopener">
    <img no-lazy src="https://z3.ax1x.com/2021/11/07/I1qTFx.png">
    <p>yeshan333</p>
  </a>
</div>

          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>首发于：2022年8月31日</p>
  </a>
</div>

          
        
          
            
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Elixir/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Elixir</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Test-Coverage/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Test Coverage</p></a></div>


          
        
      </div>
    
  </div>


  
  
  <blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app/blob/main/examples/README_cn.md">zh_hans</a></p>
</blockquote>
<p>Code coverage is an effective means to assist software engineers in verifying code quality. The runtime environment’s ability to collect code coverage fully combines black and white box testing capabilities and greatly increases engineers’ confidence in software quality. This article introduces a solution for code coverage collection in the Elixir runtime environment, and provides an in-depth insight into its internal principles.</p>
<h2 id="1-Brief-talk-on-code-coverage"><a href="#1-Brief-talk-on-code-coverage" class="headerlink" title="1. Brief talk on code coverage"></a>1. Brief talk on code coverage</h2><p>As a <a target="_blank" rel="noopener" href="https://hvitis.dev/google-qa-testing-article-on-manual-and-automation-test-engineers-sdet">SDET</a> or a SWE, we often need to write unit tests or integration test cases to verify the correctness of the system/application, but at the same time we often question whether our tests are adequate. At this time, test coverage is a means of measuring the adequacy of our testing, enhancing the success rate and confidence of the software release, and giving us more reflective perspectives. The note of the value is that high code coverage does not indicate high code quality, but conversely, code coverage is low, and code quality will not be high.</p>
<p>Most programming languages come with the ability to collect unit test coverage, and the same is true for Elixir, the official <a target="_blank" rel="noopener" href="https://hexdocs.pm/mix/1.13.4/Mix.Tasks.Test.html#module-coverage">mix</a> build tool comes with the ability to collect coverage, but it is currently only suitable for offline system, not for runtime system. This article will be based on Erlang’s cover module to give a solution for the Elixir runtime system. Since <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/cover.html">cover</a> is Erlang’s built-in module, but why it works equally well with Elixir, we’ll unveil its mystery in a follow-up. Before we get started, let’s take a look at the two mainstream ways in which the open source community collects code coverage at runtime (here we look at the bytecode stubbing method of Java, which has a huge ecosystem of the language community):</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/java_bytecode_tecs.png" class="lazyload" data-srcset="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/java_bytecode_tecs.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="java_bytecode_tecs"></p>
<p>Next let’s focus on the core of elixir runtime coverage collection in this article - the cover module.</p>
<h2 id="2-Delve-into-the-Erlang-Cover-coverage-collection-implementation-mechanism"><a href="#2-Delve-into-the-Erlang-Cover-coverage-collection-implementation-mechanism" class="headerlink" title="2. Delve into the Erlang Cover coverage collection implementation mechanism"></a>2. Delve into the Erlang Cover coverage collection implementation mechanism</h2><h3 id="2-1-Introduction-Erlang-Cover"><a href="#2-1-Introduction-Erlang-Cover" class="headerlink" title="2.1. Introduction Erlang Cover"></a>2.1. Introduction Erlang Cover</h3><p><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/cover.html">cover</a> is part of Erlang’s built-in tools set, providing a powerful ability to collect code coverage.</p>
<h3 id="2-2-Erlang-code-coverage-collection-implementation-analysis"><a href="#2-2-Erlang-code-coverage-collection-implementation-analysis" class="headerlink" title="2.2. Erlang code coverage collection implementation analysis"></a>2.2. Erlang code coverage collection implementation analysis</h3><p>As you can see from Erlang’s official manual of the cover module, cover counts the number of times every executable line in the Erlang program is executed.</p>
<p>From the introduction of the official documentation, cover can be used for code coverage collection of the runtime system. When the code is instrumented, it does not modify the code source files of any modules or the beam files generated after compilation (that is the industry calls the On-The-Fly mode). Every time the executable row is called, the runtime system updates the number of calls to cover in an in-memory database (erlang ets) for storing data for subsequent coverage analysis.</p>
<p>Next, we’ll explore the details of the On-The-Fly mode under cover.</p>
<h3 id="2-3-Learn-about-BEAM-File-Format"><a href="#2-3-Learn-about-BEAM-File-Format" class="headerlink" title="2.3. Learn about BEAM File Format"></a>2.3. Learn about BEAM File Format</h3><p>Before we can further understand the details of the cover implementation, it is necessary to understand the format of the BEAM file after the elixir source code is compiled. The compiled product of the Elixir (.ex file), like the Erlang (.erl file), is a binary chunked file, which is divided into several sections to store information used when the program runs (such as virtual machine operation instructions). In Erlang/Elixir, each module will have a corresponding BEAM file. The approximate structure of the BEAM file is as follows:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/beam_file_format.png" class="lazyload" data-srcset="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/beam_file_format.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="beam_file_format"></p>
<p>Let’s take a look at the approximate content of the beam file through an Elixir mini <a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app">demo</a> project:</p>
<ul>
<li>Step 1. Clone the project <a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app">yeshan333/explore_ast_app</a> to the local:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/yeshan333/explore_ast_app.git</span><br><span class="line">cd explore_ast_app</span><br></pre></td></tr></table></figure>

<ul>
<li>Step 2. Build this project in <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/design_principles/release_structure.html">OTP release format</a>. (note: Elixir and Erlang need to be installed locally):</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MIX_ENV=prod mix distillery.release</span><br></pre></td></tr></table></figure>

<p>It can be noted that each Elixir module is compiled into a BEAM file (can be seen in the directory <code>_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin</code>).</p>
<ul>
<li>Step 3. Next, let’s view the chunks in the Beam file through Erlang’s standard library <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/beam_lib.html#">beam_lib</a>:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> open the iex console</span></span><br><span class="line">iex -S mix</span><br></pre></td></tr></table></figure>

<p>View all chunks of the compiled BEAM file (<code>Elixir.ExploreAstApp.beam</code>):</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>iex -S mix</span><br><span class="line">Erlang/OTP <span class="number">24</span> [erts<span class="number">-12.1</span>] [source] [<span class="number">64</span>-bit] [<span class="symbol">smp:</span><span class="number">12</span><span class="symbol">:</span><span class="number">12</span>] [<span class="symbol">ds:</span><span class="number">12</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">10</span>] [async-<span class="symbol">threads:</span><span class="number">1</span>] [jit] [dtrace]</span><br><span class="line"></span><br><span class="line">Interactive Elixir (<span class="number">1.12</span>.<span class="number">3</span>) - press Ctrl+C to exit (type h() ENTER <span class="keyword">for</span> help)</span><br><span class="line">iex(<span class="number">1</span>)&gt; beam_file_path = <span class="string">&quot;_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin/Elixir.ExploreAstApp.beam&quot;</span></span><br><span class="line"><span class="string">&quot;_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin/Elixir.ExploreAstApp.beam&quot;</span></span><br><span class="line">iex(<span class="number">2</span>)&gt; all_chunks = <span class="symbol">:beam_lib</span>.all_chunks(String.to_charlist(beam_file_path))</span><br><span class="line">&#123;<span class="symbol">:ok</span>, ExploreAstApp,</span><br><span class="line"> [</span><br><span class="line">   &#123;<span class="string">&#x27;AtU8&#x27;</span>,</span><br><span class="line">    &lt;&lt;0, 0, 0, <span class="number">15</span>, <span class="number">20</span>, <span class="number">69</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">105</span>, <span class="number">114</span>, <span class="number">46</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">112</span>, <span class="number">108</span>, <span class="number">111</span>,</span><br><span class="line">      <span class="number">114</span>, <span class="number">101</span>, <span class="number">65</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">65</span>, <span class="number">112</span>, <span class="number">112</span>, <span class="number">8</span>, <span class="number">95</span>, <span class="number">95</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">102</span>, <span class="number">111</span>, <span class="number">95</span>,</span><br><span class="line">      <span class="number">95</span>, <span class="number">10</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">98</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">101</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Code&#x27;</span>,</span><br><span class="line">    &lt;&lt;0, 0, 0, <span class="number">16</span>, 0, 0, 0, 0, 0, 0, 0, <span class="number">169</span>, 0, 0, 0, <span class="number">14</span>, 0, 0, 0, <span class="number">4</span>, <span class="number">1</span>, <span class="number">16</span>,</span><br><span class="line">      <span class="number">153</span>, 0, <span class="number">2</span>, <span class="number">18</span>, <span class="number">34</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="number">32</span>, <span class="number">59</span>, <span class="number">3</span>, <span class="number">21</span>, <span class="number">23</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">50</span>, <span class="number">117</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">82</span>,</span><br><span class="line">      <span class="number">101</span>, <span class="number">98</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;StrT&#x27;</span>, <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;ImpT&#x27;</span>,</span><br><span class="line">    &lt;&lt;0, 0, 0, <span class="number">2</span>, 0, 0, 0, <span class="number">11</span>, 0, 0, 0, <span class="number">12</span>, 0, 0, 0, <span class="number">2</span>, 0, 0, 0, <span class="number">11</span>, 0, 0, 0,</span><br><span class="line">      <span class="number">12</span>, 0, 0, 0, <span class="number">1</span>&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;ExpT&#x27;</span>,</span><br><span class="line">    &lt;&lt;0, 0, 0, <span class="number">4</span>, 0, 0, 0, <span class="number">15</span>, 0, 0, 0, <span class="number">1</span>, 0, 0, 0, <span class="number">13</span>, 0, 0, 0, <span class="number">15</span>, 0, 0, 0, 0,</span><br><span class="line">      0, 0, 0, <span class="number">11</span>, 0, 0, 0, <span class="number">13</span>, 0, 0, 0, 0, 0, 0, 0, <span class="number">9</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;LitT&#x27;</span>,</span><br><span class="line">    &lt;&lt;0, 0, 0, <span class="number">52</span>, <span class="number">120</span>, <span class="number">156</span>, <span class="number">99</span>, <span class="number">96</span>, <span class="number">96</span>, <span class="number">96</span>, <span class="number">98</span>, <span class="number">96</span>, <span class="number">96</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">206</span>, <span class="number">1</span>, <span class="number">146</span>,</span><br><span class="line">      <span class="number">140</span>, <span class="number">25</span>, <span class="number">76</span>, <span class="number">229</span>, <span class="number">172</span>, <span class="number">25</span>, <span class="number">169</span>, <span class="number">57</span>, <span class="number">57</span>, <span class="number">249</span>, <span class="number">137</span>, <span class="number">12</span>, <span class="number">89</span>, <span class="number">64</span>, <span class="number">190</span>, <span class="number">88</span>,</span><br><span class="line">      <span class="number">115</span>, <span class="number">46</span>, <span class="number">144</span>, <span class="number">20</span>, <span class="number">248</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;LocT&#x27;</span>, &lt;&lt;0, 0, 0, 0&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Attr&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">108</span>, 0, 0, 0, <span class="number">1</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, 0, <span class="number">3</span>, <span class="number">118</span>, <span class="number">115</span>, <span class="number">110</span>, <span class="number">108</span>, 0, 0, 0, <span class="number">1</span>,</span><br><span class="line">      <span class="number">110</span>, <span class="number">16</span>, 0, <span class="number">165</span>, <span class="number">236</span>, <span class="number">94</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">160</span>, <span class="number">184</span>, <span class="number">33</span>, <span class="number">240</span>, <span class="number">28</span>, <span class="number">89</span>, <span class="number">11</span>, <span class="number">22</span>, <span class="number">130</span>,</span><br><span class="line">      <span class="number">207</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;CInf&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">108</span>, 0, 0, 0, <span class="number">3</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, 0, <span class="number">7</span>, <span class="number">118</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">111</span>,</span><br><span class="line">      <span class="number">110</span>, <span class="number">107</span>, 0, <span class="number">5</span>, <span class="number">56</span>, <span class="number">46</span>, <span class="number">48</span>, <span class="number">46</span>, <span class="number">51</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, 0, <span class="number">7</span>, <span class="number">111</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>,</span><br><span class="line">      <span class="number">111</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Dbgi&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">80</span>, 0, 0, <span class="number">1</span>, <span class="number">143</span>, <span class="number">120</span>, <span class="number">156</span>, <span class="number">117</span>, <span class="number">80</span>, <span class="number">203</span>, <span class="number">78</span>, <span class="number">3</span>, <span class="number">49</span>, <span class="number">12</span>, <span class="number">76</span>, <span class="number">233</span>, <span class="number">67</span>,</span><br><span class="line">      <span class="number">162</span>, <span class="number">5</span>, <span class="number">113</span>, <span class="number">65</span>, <span class="number">124</span>, <span class="number">70</span>, <span class="number">87</span>, <span class="number">253</span>, <span class="number">2</span>, <span class="number">212</span>, <span class="number">67</span>, <span class="number">63</span>, <span class="number">129</span>, <span class="number">115</span>, <span class="number">148</span>, <span class="number">221</span>,</span><br><span class="line">      <span class="number">120</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Docs&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">80</span>, 0, 0, 0, <span class="number">241</span>, <span class="number">120</span>, <span class="number">156</span>, <span class="number">93</span>, <span class="number">142</span>, <span class="number">205</span>, <span class="number">10</span>, <span class="number">194</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">132</span>, <span class="number">215</span>,</span><br><span class="line">      <span class="number">74</span>, <span class="number">91</span>, <span class="number">9</span>, <span class="number">248</span>, <span class="number">14</span>, <span class="number">129</span>, <span class="number">94</span>, <span class="number">244</span>, <span class="number">82</span>, <span class="number">241</span>, <span class="number">234</span>, <span class="number">65</span>, <span class="number">40</span>, <span class="number">88</span>, <span class="number">241</span>, <span class="number">45</span>, <span class="number">108</span>,</span><br><span class="line">      ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;ExCk&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, 0, <span class="number">17</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">105</span>, <span class="number">114</span>, <span class="number">95</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">101</span>,</span><br><span class="line">      <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">95</span>, <span class="number">118</span>, <span class="number">49</span>, <span class="number">116</span>, 0, 0, 0, <span class="number">1</span>, <span class="number">100</span>, 0, <span class="number">7</span>, <span class="number">101</span>, <span class="number">120</span>,</span><br><span class="line">      ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Line&#x27;</span>,</span><br><span class="line">    &lt;&lt;0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, <span class="number">4</span>, 0, 0, 0, <span class="number">1</span>, 0, 0, 0, <span class="number">1</span>, <span class="number">18</span>, <span class="number">241</span>, 0,</span><br><span class="line">      <span class="number">22</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">98</span>, <span class="number">47</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">112</span>, <span class="number">108</span>, ...&gt;&gt;&#125;</span><br><span class="line"> ]&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see, the obtained chunks correspond to the previous diagram. We can also obtain the Erlang AST (abstract syntax tree) corresponding to the module (<code>ExploreAstApp</code>) through the beam_lib standard library:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">3</span>)&gt; result = <span class="symbol">:beam_lib</span>.chunks(String.to_charlist(beam_file_path), [<span class="symbol">:abstract_code</span>])</span><br><span class="line">&#123;<span class="symbol">:ok</span>,</span><br><span class="line"> &#123;ExploreAstApp,</span><br><span class="line">  [</span><br><span class="line">    <span class="symbol">abstract_code:</span> &#123;<span class="symbol">:raw_abstract_v1</span>,</span><br><span class="line">     [</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:file</span>, &#123;<span class="string">&#x27;lib/explore_ast_app.ex&#x27;</span>, <span class="number">1</span>&#125;&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:module</span>, ExploreAstApp&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:compile</span>, [<span class="symbol">:no_auto_import</span>]&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:export</span>, [<span class="symbol">__info__:</span> <span class="number">1</span>, <span class="symbol">hello:</span> 0]&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:spec</span>,</span><br><span class="line">        &#123;&#123;<span class="symbol">:__info__</span>, <span class="number">1</span>&#125;,</span><br><span class="line">         [</span><br><span class="line">           &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:fun</span>,</span><br><span class="line">            [</span><br><span class="line">              &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:product</span>,</span><br><span class="line">               [</span><br><span class="line">                 &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:union</span>,</span><br><span class="line">                  [</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:attributes</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:compile</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:functions</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:macros</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:md5</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:exports_md5</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:module</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:deprecated</span>&#125;</span><br><span class="line">                  ]&#125;</span><br><span class="line">               ]&#125;,</span><br><span class="line">              &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:any</span>, []&#125;</span><br><span class="line">            ]&#125;</span><br><span class="line">         ]&#125;&#125;,</span><br><span class="line">       &#123;<span class="symbol">:function</span>, 0, <span class="symbol">:__info__</span>, <span class="number">1</span>,</span><br><span class="line">        [</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:module</span>&#125;], [], [&#123;<span class="symbol">:atom</span>, 0, ExploreAstApp&#125;]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:functions</span>&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:cons</span>, 0, &#123;<span class="symbol">:tuple</span>, 0, [&#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:hello</span>&#125;, &#123;<span class="symbol">:integer</span>, 0, 0&#125;]&#125;,</span><br><span class="line">              &#123;<span class="keyword">nil</span>, 0&#125;&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:macros</span>&#125;], [], [<span class="symbol">nil:</span> 0]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:exports_md5</span>&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:bin</span>, 0,</span><br><span class="line">              [</span><br><span class="line">                &#123;<span class="symbol">:bin_element</span>, 0,</span><br><span class="line">                 &#123;<span class="symbol">:string</span>, 0,</span><br><span class="line">                  [<span class="number">240</span>, <span class="number">105</span>, <span class="number">247</span>, <span class="number">119</span>, <span class="number">22</span>, <span class="number">50</span>, <span class="number">219</span>, <span class="number">207</span>, <span class="number">90</span>, <span class="number">95</span>, <span class="number">127</span>, <span class="number">92</span>, ...]&#125;,</span><br><span class="line">                 <span class="symbol">:default</span>, <span class="symbol">:default</span>&#125;</span><br><span class="line">              ]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:match</span>, 0, &#123;<span class="symbol">:var</span>, 0, <span class="symbol">:Key</span>&#125;, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:attributes</span>&#125;&#125;],</span><br><span class="line">           [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:call</span>, 0,</span><br><span class="line">              &#123;<span class="symbol">:remote</span>, 0, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:erlang</span>&#125;, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:get_module_info</span>&#125;&#125;,</span><br><span class="line">              [&#123;<span class="symbol">:atom</span>, 0, ExploreAstApp&#125;, &#123;<span class="symbol">:var</span>, 0, <span class="symbol">:Key</span>&#125;]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:match</span>, 0, &#123;<span class="symbol">:var</span>, 0, <span class="symbol">:Key</span>&#125;, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:compile</span>&#125;&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:call</span>, 0,</span><br><span class="line">              &#123;<span class="symbol">:remote</span>, 0, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:erlang</span>&#125;, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:get_module_info</span>&#125;&#125;,</span><br><span class="line">              [&#123;<span class="symbol">:atom</span>, 0, ExploreAstApp&#125;, &#123;<span class="symbol">:var</span>, 0, <span class="symbol">:Key</span>&#125;]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:match</span>, 0, &#123;<span class="symbol">:var</span>, 0, <span class="symbol">:Key</span>&#125;, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:md5</span>&#125;&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:call</span>, 0,</span><br><span class="line">              &#123;<span class="symbol">:remote</span>, 0, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:erlang</span>&#125;, &#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:get_module_info</span>&#125;&#125;,</span><br><span class="line">              [&#123;<span class="symbol">:atom</span>, 0, ExploreAstApp&#125;, &#123;<span class="symbol">:var</span>, 0, <span class="symbol">:Key</span>&#125;]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, 0, [&#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:deprecated</span>&#125;], [], [<span class="symbol">nil:</span> 0]&#125;</span><br><span class="line">        ]&#125;,</span><br><span class="line">       &#123;<span class="symbol">:function</span>, <span class="number">15</span>, <span class="symbol">:hello</span>, 0, [&#123;<span class="symbol">:clause</span>, <span class="number">15</span>, [], [], [&#123;<span class="symbol">:atom</span>, 0, <span class="symbol">:world</span>&#125;]&#125;]&#125;</span><br><span class="line">     ]&#125;</span><br><span class="line">  ]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>It can be seen that AST is expressed in the form of <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/reference_manual/data_types.html#terms">Erlang Terms</a> (called Abstract Code), which is easy to read. The Abstract Code is very useful in the on-the-fly instrumentation process of cover.</p>
<p>The above AST structure is simple and easy to read, and we can easily match it with the source code (<code>lib/explore_ast_app.ex</code>) before the module is compiled, although the AST structure is the final Erlang AST, and some extras information are added by the Erlang compiler, but does not affect reading:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/ex_source_ast_code_mapper.png" class="lazyload" data-srcset="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/ex_source_ast_code_mapper.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ex_source_ast_code_mapper"></p>
<p>The second element in the tuple generally represents the number of source code lines. You can learn more about Erlang’s Abstract Format through the official documentation. By observing the Erlang AST structure of several BEAM files, you will be familiar with it. It is worth noting that the Abstract Code was stored in the Abstract Chunk of the BEAM file before OTP 20.</p>
<p>If you want to learn more about BEAM files in detail, you can check out the following two documents:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://beam-wisdoms.clau.se/en/latest/indepth-beam-file.html#beam-term-format">http://beam-wisdoms.clau.se/en/latest/indepth-beam-file.html#beam-term-format</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stenmans.org/theBeamBook/#BEAM_files">https://blog.stenmans.org/theBeamBook/#BEAM_files</a></li>
</ul>
<h3 id="2-4-Elixir-source-code-compilation-process"><a href="#2-4-Elixir-source-code-compilation-process" class="headerlink" title="2.4. Elixir source code compilation process"></a>2.4. Elixir source code compilation process</h3><p>After understanding BEAM File Format, we also need to understand the compilation process of Elixir code, which will help us better understand cover. The process of compiling Elixir source code into BEAM file may not be as you imagined In the same way, instead of directly from Elixir’s AST, it becomes executable BEAM Code after being processed by the compiler backend. There is also a process in the middle, as shown in the following figure:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/Elixir-Compilation.jpg" class="lazyload" data-srcset="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/Elixir-Compilation.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="Elixir-Compilation-Process"></p>
<p>The above process can be described as:</p>
<ul>
<li><p>Step 1、The Elixir source code will be parsed by a custom lexical analyzer (<a target="_blank" rel="noopener" href="https://github.com/elixir-lang/elixir/blob/main/lib/elixir/src/elixir_tokenizer.erl">elixir_tokenizer</a>) and <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/yecc.html">yacc</a> to generate the initial version of Elixir AST, which is expressed in the form of Elixir Terms; if you are interested in Elixir’s AST, you can follow this Project <a target="_blank" rel="noopener" href="https://github.com/arjan/ast_ninja">arjan/ast_ninja</a>;</p>
</li>
<li><p>Step 2、In the Elixir AST stage, some custom and built-in Macros have not been expanded, and these Macros are expanded into the final Elixir AST in the Expanded Elixir AST stage;</p>
</li>
<li><p>Step 3、Final Elixir AST will be converted into Erlang standard AST form (<a target="_blank" rel="noopener" href="https://www.erlang.org/doc/apps/erts/absform.html">Erlang Abstract Format</a>) after being processed by Elixir Compiler;</p>
</li>
<li><p>Step 4、Finally, Elixir will use the Erlang Compiler to process the Erlang AST, converting it into BEAM bytecode executable by the BEAM Virtual Machine (VM). For details on the compiler, see: <a target="_blank" rel="noopener" href="https://github.com/elixir-lang/elixir/blob/main/lib/elixir/src/elixir_compiler.erl">elixir_compiler.erl</a> and <a target="_blank" rel="noopener" href="https://github.com/elixir-lang/elixir/blob/main/lib/elixir/src/elixir_erl.erl">elixir_erl.erl</a> source code For more details on the Erlang Compiler, see <a target="_blank" rel="noopener" href="https://blog.stenmans.org/theBeamBook/#CH-Compiler">theBeamBook/#CH-Compiler</a>.</p>
</li>
</ul>
<h3 id="2-5-Cover-On-The-Fly-Instrumentation-Implementation"><a href="#2-5-Cover-On-The-Fly-Instrumentation-Implementation" class="headerlink" title="2.5. Cover On-The-Fly Instrumentation Implementation"></a>2.5. Cover On-The-Fly Instrumentation Implementation</h3><p>Now it’s time for dinner. Let’s see how cover performs instrumentation and coverage collection. To use cover to complete code coverage collection, we must know three dragon-slaying swords:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/swords.jpg" class="lazyload" data-srcset="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/swords.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="three dragon-slaying swords"></p>
<ul>
<li><p><code>cover:start</code>: Used to create the cover coverage collection process, it will complete the creation of the relevant ets table to store the coverage data, <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L159">cover.erl#L159</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L632">cover.erl#L632</a>, and we can also start the cover process of the remote Erlang node.</p>
</li>
<li><p><code>cover:compile_beam</code>: For instrumentation, cover will read the content of the abstract_code of the BEAM file, namely Erlang AST. The key code is in <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1541">cover.erl#L1541</a>, and then transform and munge the Erlang AST From, it will call <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1938">bump_call</a>, after each executable line will insert the following abstract_code:</p>
</li>
</ul>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;call,A,&#123;remote,A,&#123;atom,A,ets&#125;,&#123;atom,A,update_counter&#125;&#125;,</span><br><span class="line"> [&#123;atom,A,?COVER_TABLE&#125;,</span><br><span class="line">  &#123;tuple,A,[&#123;atom,A,?BUMP_REC_NAME&#125;,</span><br><span class="line">            &#123;atom,A,Vars#vars.module&#125;,</span><br><span class="line">            &#123;atom,A,Vars#vars.function&#125;,</span><br><span class="line">            &#123;integer,A,Vars#vars.arity&#125;,</span><br><span class="line">            &#123;integer,A,Vars#vars.clause&#125;,</span><br><span class="line">            &#123;integer,A,Line&#125;]&#125;,</span><br><span class="line">  &#123;integer,A,<span class="number">1</span>&#125;]&#125;.</span><br></pre></td></tr></table></figure>

<p>From the previous understanding of Erlang AST, we know that this is equivalent to inserting the following line of code:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ets:update_counter(?COVER_TABLE, #bump&#123;module=Module, function=Function, arity=Arity, clause=Clause, line=Line&#125;, <span class="number">1</span>).</span><br></pre></td></tr></table></figure>

<p>Then for the mungeed Erlang AST Form, cover uses the Erlang Compiler to obtain the Erlang Beam Code (also known as object code. i.e. bytecode, VM execution instructions) from the mungeed AST expression form. <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1580">cover.erl#L1580</a>. And then use the Erlang <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/code.html#load_binary-3">code server</a> to replace the old object code with the new object code obtained, <code>load_binary</code> <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1581">cover.erl#L1581</a> into <a target="_blank" rel="noopener" href="https://blog.stenmans.org/theBeamBook/#P-ERTS">ERTS</a> (Erlang Run Time System). cover completes the Erlang AST instrumentation process, so that whenever the executable line is Executed, the corresponding ets storage table will update the number of times the code line was called.</p>
<ul>
<li><code>cover:analyze</code>: Analyze the data stored in the ets table to obtain the number of times the executable line was executed (called), which can be used for statistical coverage data.</li>
</ul>
<blockquote>
<p>munge: Used to make a series of potentially destructive or irreversible changes to data or files.</p>
</blockquote>
<h2 id="3-Elixir-Application-runtime-coverage-collection-example"><a href="#3-Elixir-Application-runtime-coverage-collection-example" class="headerlink" title="3. Elixir Application runtime coverage collection example"></a>3. Elixir Application runtime coverage collection example</h2><p>Through the above, after understanding the implementation details of the Erlang Cover module. Let us take a deployed and running Elixir Application (we will use the previous <a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app">yesan333/explore_ast_app</a>) as an example to perform large-scale tests (system &amp; integration tests) of the Elixir application runtime of code line-level coverage collection.</p>
<p>Here we will use a tool library: <a target="_blank" rel="noopener" href="https://github.com/yeshan333/ex_integration_coveralls">ex_integration_coveralls</a> for coverage analysis, which is an Elixir Wrapper for the Erlang module cover to collection Elixir runtime system coverage. Let’s start:</p>
<ul>
<li>Step 1、Add <code>ex_integration_coveralls</code> dependency to <code>mix.exs</code> file:</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">deps</span></span> <span class="keyword">do</span></span><br><span class="line">  [</span><br><span class="line">    ...,</span><br><span class="line">    &#123;<span class="symbol">:ex_integration_coveralls</span>, <span class="string">&quot;~&gt; 0.3.0&quot;</span>&#125;</span><br><span class="line">  ]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Pull the dependencies and rebuild the project:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mix deps.get</span><br><span class="line">MIX_ENV=prod mix distillery.release</span><br></pre></td></tr></table></figure>

<ul>
<li>Step 2、Start the project:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_build/prod/rel/explore_ast_app/bin/explore_ast_app foreground</span><br></pre></td></tr></table></figure>

<ul>
<li>Step 3、Connect to the remote_console of the Elixir runtime application node:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_build/prod/rel/explore_ast_app/bin/explore_ast_app remote_console</span><br></pre></td></tr></table></figure>

<ul>
<li>Step 4、Use <code>ex_integration_coveralls</code> (ExIntegrationCoveralls.execute) to start cover and perform code coverage collection:</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">1</span>&gt; compiled_beam_dir_path = <span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app/_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin&quot;</span></span><br><span class="line"><span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app/_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin&quot;</span></span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">2</span>&gt; ExIntegrationCoveralls.execute(compiled_beam_dir_path)</span><br><span class="line">[</span><br><span class="line">  <span class="symbol">ok:</span> ExploreAstApp.Router,</span><br><span class="line">  <span class="symbol">ok:</span> ExploreAstApp.Plug.VerifyRequest.IncompleteRequestError,</span><br><span class="line">  <span class="symbol">ok:</span> ExploreAstApp.Plug.VerifyRequest,</span><br><span class="line">  <span class="symbol">ok:</span> ExploreAstApp.Application,</span><br><span class="line">  <span class="symbol">ok:</span> ExploreAstApp</span><br><span class="line">]</span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">3</span>&gt; compile_time_source_lib_abs_path = <span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line"><span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">4</span>&gt; source_code_abs_path = <span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line"><span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">5</span>&gt; ExIntegrationCoveralls.get_total_coverage(compile_time_source_lib_abs_path, source_code_abs_path)</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>As you can see, the initial coverage is 0, because no code has been called yet.</p>
<ul>
<li>Step 5、Let’s execute the following cURL. Let code be called:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --location --request GET <span class="string">&#x27;http://localhost:8080/hello&#x27;</span></span></span><br><span class="line">hello %</span><br></pre></td></tr></table></figure>

<p>Check out the code coverage data again in iex console:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">6</span>&gt; ExIntegrationCoveralls.get_total_coverage(compile_time_source_lib_abs_path, source_code_abs_path)</span><br><span class="line"><span class="number">17.1</span></span><br></pre></td></tr></table></figure>

<p>As you can see, the cURL (test case) coverage for this project is 17.1%.</p>
<p>We can also use the following methods to view more detailed code coverage, such as viewing the code coverage of <code>lib/explore_ast_app/router.ex</code> (<code>nil</code> means the line is not an executable line):</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">7</span>&gt; result = ExIntegrationCoveralls.get_coverage_report(compile_time_source_lib_abs_path, source_code_abs_path)</span><br><span class="line">.......</span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.0.0.<span class="number">1</span>)<span class="number">8</span>&gt; Enum.at(Map.get(result, <span class="symbol">:files</span>), <span class="number">3</span>)</span><br><span class="line">%ExIntegrationCoveralls.Stats.Source&#123;</span><br><span class="line">  <span class="symbol">coverage:</span> <span class="number">18.2</span>,</span><br><span class="line">  <span class="symbol">filename:</span> <span class="string">&quot;lib/explore_ast_app/router.ex&quot;</span>,</span><br><span class="line">  <span class="symbol">hits:</span> <span class="number">4</span>,</span><br><span class="line">  <span class="symbol">misses:</span> <span class="number">18</span>,</span><br><span class="line">  <span class="symbol">sloc:</span> <span class="number">22</span>,</span><br><span class="line">  <span class="symbol">source:</span> [</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">1</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;defmodule ExploreAstApp.Router do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="number">1</span>, <span class="symbol">source:</span> <span class="string">&quot;  use Plug.Router&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  use Plug.ErrorHandler&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  import Plug.Conn&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  alias ExploreAstApp.Plug.VerifyRequest&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug Plug.Parsers, parsers: [:urlencoded, :multipart]&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug VerifyRequest, fields: [\&quot;content\&quot;, \&quot;mimetype\&quot;], paths: [\&quot;/upload\&quot;]&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  plug :match&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug Plug.Parsers, parsers: [:json], pass: [\&quot;application/json\&quot;], json_decoder: Jason&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug :dispatch&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/welcome\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    send_resp(conn, 200, \&quot;Welcome\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/upload\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    send_resp(conn, 201, \&quot;Uploaded\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">1</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/hello\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # query parameter is user like this:&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # http://localhost:4001/hello?name=John&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # which will create %&#123;\&quot;name\&quot; =&gt; \&quot;John\&quot;&#125;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">1</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;      send_resp(conn, 200, \&quot;hello \#&#123;Map.get(conn.query_params, \&quot;name\&quot;)&#125;\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/hello/:name\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    send_resp(conn, 200, \&quot;hello \#&#123;name&#125;\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  post \&quot;/hello\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # json body of POST request &#123;\&quot;name\&quot;: \&quot;John\&quot;&#125; is parsed to %&#123;\&quot;name\&quot; =&gt; \&quot;John\&quot;&#125;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # so it can be accesable with e.g. Map.get(conn.body_params, \&quot;name\&quot;) or with pattern matching&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> 0, <span class="symbol">source:</span> <span class="string">&quot;    name =&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;      case conn.body_params do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> 0,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;        %&#123;\&quot;name\&quot; =&gt; a_name &#125; -&gt; a_name&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="keyword">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;        _ -&gt; \&quot;\&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;      end&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;<span class="symbol">coverage:</span> <span class="keyword">nil</span>, ...&#125;,</span><br><span class="line">    %ExIntegrationCoveralls.Stats.Line&#123;...&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Based on the <code>post_cov_stats_to_ud_ci</code> interface, it is possible to further interface with internal or external <a target="_blank" rel="noopener" href="https://about.codecov.io/">Codecov</a>-like coverage systems.</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage_system.jpg" class="lazyload" data-srcset="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage_system.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="coverage_system"></p>
<p>Based on this, we can realize the collection of code coverage with large-scale (integration &amp; system) testing capabilities without stopping the Elixir Application.</p>
<h2 id="4-Continuous-runtime-coverage-collection-solution-for-large-scale-Elixir-Erlang-Microservice-clusters"><a href="#4-Continuous-runtime-coverage-collection-solution-for-large-scale-Elixir-Erlang-Microservice-clusters" class="headerlink" title="4. Continuous runtime coverage collection solution for large-scale Elixir/Erlang Microservice clusters"></a>4. Continuous runtime coverage collection solution for large-scale Elixir/Erlang Microservice clusters</h2><p>With the continuous expansion of the Elixir/Erlang microservice system, the coverage collection method shown in the previous section needs further evolution. Referring to the design of <a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/#architecture">Prometheus Pull-Base</a>, the overall design (combination of Pull &amp; Push mode) is as follows:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage-arch.jpg" class="lazyload" data-srcset="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage-arch.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="coverage_system_design"></p>
<p>We expand based on <a target="_blank" rel="noopener" href="https://github.com/yeshan333/ex_integration_coveralls">ex_integration_coveralls</a>. After the Elixir Application is started, a http worker is started up to expose the code coverage data in real time, which is convenient for communication with heterogeneous systems. The Coverage Push Gateway is responsible for regularly pulling the coverage data (Gateway can be a OTP Application, which allows <code>ex_integration_coveralls</code> to directly start up the custom <a target="_blank" rel="noopener" href="https://github.com/yeshan333/ex_integration_coveralls/blob/main/lib/ex_integration_coveralls/cov_stats_worker.ex">GenServer Worker</a> for interactive integration test system in the distributed OTP system), after the integration/system test system informs the end of the test, the Gateway pushes the coverage data to the <code>Cover Center</code> for code coverage rate display.</p>
<p>End (long way to go).</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36f4140541f8dd555fb8aaee2fd719d59ffab041.pdf">Code Coverage at Google</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/cover.html#description">Erlang cover</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/blog/a-brief-beam-primer/">A brief introduction to BEAM</a></li>
<li><a target="_blank" rel="noopener" href="http://gomoripeti.github.io/beam_by_example/">A peak into the Erlang compiler and BEAM bytecode</a></li>
<li><a target="_blank" rel="noopener" href="https://elixirforum.com/t/getting-each-stage-of-elixirs-compilation-all-the-way-to-the-beam-bytecode/1873/5">Getting each stage of Elixir’s compilation all the way to the BEAM bytecode</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/parroty/excoveralls">excoveralls</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hrzndhrn/beam_file">BeamFile - A peek into the BEAM file</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/KronicDeth/intellij-elixir#beam-files">https://github.com/KronicDeth/intellij-elixir#beam-files</a></li>
</ul>

  
  
    
    <div class='footer'>
      
      
      
        <div class='copyright'>
          <blockquote>
            
              
                <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

              
            
              
                <p>我的博客即将同步至腾讯云+社区，邀请大家一同入驻：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/support-plan?invite_code=1utoln9pyvwqu">https://cloud.tencent.com/developer/support-plan?invite_code=1utoln9pyvwqu</a></p>

              
            
          </blockquote>
        </div>
      
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2022-08-31T22:43:10+00:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2022年8月31日</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Elixir/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Elixir</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Test-Coverage/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Test Coverage</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://yeshan333.github.io/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/&title=the-solution-of-elixir-continuous-runtime-system-code-coverage-collection - ShanSan&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qq.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qq.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://yeshan333.github.io/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/&title=the-solution-of-elixir-continuous-runtime-system-code-coverage-collection - ShanSan&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qzone.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qzone.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://service.weibo.com/share/share.php?url=https://yeshan333.github.io/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/&title=the-solution-of-elixir-continuous-runtime-system-code-coverage-collection - ShanSan&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/weibo.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/weibo.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=">
          
        </a>
      
    
      
    
      
    
  </div>
</div>



        
      
    </div>
  </div>


  
  

  
    <div class="prev-next">
      
      
        <a class='next' href='/2022/06/29/elixir-run-time-code-line-level-coverage-collection/'>
          <p class='title'>Elixir 连续运行时代码覆盖率采集方案<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>1. 浅谈代码覆盖率作为 SET 和 SWE, 我们经常需要编写单元测试或集成测试用例来验证系统/应用的正确性, 但同时我们也常会质疑我们的测试是否充分了. 这时测试覆盖率是可以辅助用来衡量我们...</p>
        </a>
      
    </div>
  
</article>


  

  <article class="post white-box reveal shadow" id="comments">
    <p ct><i class='fas fa-comments'></i> 评论</p>
    
    <div id="waline">
  <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
</div>

  </article>





  <script>
  // https://github.com/theme-next/hexo-theme-next/blob/master/layout/_third-party/math/mathjax.swig
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.0/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    // 文章章节标题不能为 “MathJax” ，否则会报错。
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>



</div>
<aside class='l_side'>
  
  
    
    



  <section class="widget toc-wrapper shadow desktop mobile" id="toc-div" >
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Brief-talk-on-code-coverage"><span class="toc-text">1. Brief talk on code coverage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Delve-into-the-Erlang-Cover-coverage-collection-implementation-mechanism"><span class="toc-text">2. Delve into the Erlang Cover coverage collection implementation mechanism</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Introduction-Erlang-Cover"><span class="toc-text">2.1. Introduction Erlang Cover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Erlang-code-coverage-collection-implementation-analysis"><span class="toc-text">2.2. Erlang code coverage collection implementation analysis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Learn-about-BEAM-File-Format"><span class="toc-text">2.3. Learn about BEAM File Format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Elixir-source-code-compilation-process"><span class="toc-text">2.4. Elixir source code compilation process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Cover-On-The-Fly-Instrumentation-Implementation"><span class="toc-text">2.5. Cover On-The-Fly Instrumentation Implementation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Elixir-Application-runtime-coverage-collection-example"><span class="toc-text">3. Elixir Application runtime coverage collection example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Continuous-runtime-coverage-collection-solution-for-large-scale-Elixir-Erlang-Microservice-clusters"><span class="toc-text">4. Continuous runtime coverage collection solution for large-scale Elixir&#x2F;Erlang Microservice clusters</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-text">References</span></a></li></ol>
    </div>
  </section>


  


</aside>



		  
		  <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->

<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.postTitle="the-solution-of-elixir-continuous-runtime-system-code-coverage-collection";
  pdata.commentPath="";
  pdata.commentPlaceholder="";
  // header 这里无论是否开启pjax都需要
  var l_header=document.getElementById("l_header");
  
  l_header.classList.add("show");
  
  
</script>

        </div>
        
  
  <footer class="footer clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='320px'
      server='netease'
      type='playlist'
      id='6729508229'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="mailto:1329441308@qq.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
            
              <a href="https://github.com/yeshan333?tab=repositories"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
            
              <a href="https://music.163.com/#/my/m/music/playlist?id=2617691792"
                class="social fas fa-music flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
            
              <a href="https://www.zhihu.com/people/si-kong-ji-54/activities"
                class="social fab fa-zhihu flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
            
              <a href="https://yeshan333.github.io/rss2.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        本站使用
        <a href="https://github.com/volantis-x/hexo-theme-volantis/tree/4.3.1" target="_blank" class="codename">Volantis</a>
        作为主题，总访问量为
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          次
        
      
    
      
        <div class='copyright'>
        <p><a target="_blank" rel="noopener" href="https://shansan.top/">Copyright © 2018-2022 ShanSan</a></p>

        </div>
      
    
      
        
          <div><p><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">桂ICP备19000444号</a></p>
</div>
        
      
    
  </footer>


        <a id="s-top" class="fas fa-arrow-up fa-fw" href="javascript:void(0)"></a>
      </div>
    </div>
    <div>
      <script>
/************这个文件存放不需要重载的全局变量和全局函数*********/
window.volantis={};
window.volantis.loadcss=document.getElementById("loadcss");
/******************** Pjax ********************************/
function VPjax(){
	this.list=[] // 存放回调函数
	this.start=()=>{
	  for(var i=0;i<this.list.length;i++){
		this.list[i].run();
	  }
	}
	this.push=(fn,name)=>{
		var f=new PjaxItem(fn,name);
		this.list.push(f);
	}
	// 构造一个可以run的对象
	function PjaxItem(fn,name){
		// 函数名称
		this.name = name || fn.name
		// run方法
		this.run=()=>{
			fn()
		}
	}
}
volantis.pjax={}
volantis.pjax.method={
	complete: new VPjax(),
	error: new VPjax(),
	send: new VPjax()
}
volantis.pjax={
	...volantis.pjax,
	push: volantis.pjax.method.complete.push,
	error: volantis.pjax.method.error.push,
	send: volantis.pjax.method.send.push
}
/********************脚本懒加载函数********************************/
// 已经加入了setTimeout
function loadScript(src, cb) {
	setTimeout(function() {
		var HEAD = document.getElementsByTagName('head')[0] || document.documentElement;
		var script = document.createElement('script');
		script.setAttribute('type','text/javascript');
		if (cb) script.onload = cb;
		script.setAttribute('src', src);
		HEAD.appendChild(script);
	});
}
//https://github.com/filamentgroup/loadCSS
var loadCSS = function( href, before, media, attributes ){
	var doc = window.document;
	var ss = doc.createElement( "link" );
	var ref;
	if( before ){
		ref = before;
	}
	else {
		var refs = ( doc.body || doc.getElementsByTagName( "head" )[ 0 ] ).childNodes;
		ref = refs[ refs.length - 1];
	}
	var sheets = doc.styleSheets;
	if( attributes ){
		for( var attributeName in attributes ){
			if( attributes.hasOwnProperty( attributeName ) ){
				ss.setAttribute( attributeName, attributes[attributeName] );
			}
		}
	}
	ss.rel = "stylesheet";
	ss.href = href;
	ss.media = "only x";
	function ready( cb ){
		if( doc.body ){
			return cb();
		}
		setTimeout(function(){
			ready( cb );
		});
	}
	ready( function(){
		ref.parentNode.insertBefore( ss, ( before ? ref : ref.nextSibling ) );
	});
	var onloadcssdefined = function( cb ){
		var resolvedHref = ss.href;
		var i = sheets.length;
		while( i-- ){
			if( sheets[ i ].href === resolvedHref ){
				return cb();
			}
		}
		setTimeout(function() {
			onloadcssdefined( cb );
		});
	};
	function loadCB(){
		if( ss.addEventListener ){
			ss.removeEventListener( "load", loadCB );
		}
		ss.media = media || "all";
	}
	if( ss.addEventListener ){
		ss.addEventListener( "load", loadCB);
	}
	ss.onloadcssdefined = onloadcssdefined;
	onloadcssdefined( loadCB );
	return ss;
};
</script>
<script>
  
  loadCSS("https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14/css/all.min.css", window.volantis.loadcss);
  
  
  
  
</script>
<!-- required -->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script>

<script>
  function pjax_fancybox() {
    $(".md .gallery").find("img").each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("class", "fancybox");
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 判断当前页面是否存在描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".md .gallery").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  function SCload_fancybox() {
    if ($(".md .gallery").find("img").length == 0) return;
    loadCSS("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css", document.getElementById("loadcss"));
    loadScript('https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', pjax_fancybox)
  };
  $(function () {
    SCload_fancybox();
  });
  function Pjax_SCload_fancybox(){
	if (typeof $.fancybox == "undefined") {
	 SCload_fancybox();
    } else {
	 pjax_fancybox();
    }
  }
  volantis.pjax.push(Pjax_SCload_fancybox)
  volantis.pjax.send(()=>{
      if (typeof $.fancybox != "undefined") {
        $.fancybox.close();    // 关闭弹窗
      }
  },'fancybox')
</script>


<!-- internal -->




<script>
  function loadIssuesJS() {
    if ($(".md").find(".issues-api").length == 0) return;
	
	  loadScript('/js/issues.js');
	
  };
  $(function () {
    loadIssuesJS();
  });
  volantis.pjax.push(()=>{
	if (typeof IssuesAPI == "undefined") {
	  loadIssuesJS();
	}
  },"IssuesJS")
</script>



  <script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  

<script>
  window.FPConfig = {
	delay: 0,
	ignoreKeywords: [],
	maxRPS: 5,
	hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>





  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
    var clipboard = new ClipboardJS('.btn-copy', {
        target: function (trigger) {
            return trigger.nextElementSibling
        }
    });
    function wait(callback, seconds) {
        var timelag = null;
        timelag = window.setTimeout(callback, seconds)
    }
    function pjax_initCopyCode() {
		if($(".highlight .code pre").length+$(".article pre code").length==0)return;
        var copyHtml = '';
        copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
        copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
        copyHtml += '</button>';
        $(".highlight .code pre").before(copyHtml);
        $(".article pre code").before(copyHtml);
        clipboard.off('success').on('success', function (e) {
            let $btn = $(e.trigger);
            $btn.addClass('copied');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-check-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPIED';
            wait(function () {
                $icon.removeClass('fa-check-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        });
        clipboard.off('error').on('error', function (e) {
            e.clearSelection();
            let $btn = $(e.trigger);
            $btn.addClass('copy-failed');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-times-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPY FAILED';
            wait(function () {
                $icon.removeClass('fa-times-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        })
    }
    $(function () {
        pjax_initCopyCode()
    });
	volantis.pjax.push(pjax_initCopyCode)
</script>






  <script>
  let APlayerController = new Object();
  APlayerController.id = '6729508229';  // 设定全局音乐播放ID
  APlayerController.volume = '0.7';
  loadCSS("https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css", window.volantis.loadcss);
  // APlayer 需要在  MetingJS 之前加载
  loadScript("https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js")
  window.volantis.APlayerLoaded=0 // APlayer加载完成状态
  var checkAPlayer = setInterval(function () {
    if (!window.APlayer) return // APlayer加载完成？
	  if ($("#safearea").css("display")!="block") return // 文章内容加载完成？ see: source/css/first.styl
    clearInterval(checkAPlayer)
	  if (!window.volantis.APlayerLoaded&&!window.MetingJSElement){ // APlayer只能加载一次
      window.volantis.APlayerLoaded=1 // APlayer加载完成
      loadScript("https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js") // 加载 MetingJS
	  }
  }, 2500) // 按照网速调节差分2.5s
  // rightmenu see: layout/_partial/rightmenu.ejs

</script>




  
  
<script src="https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js"></script>


<script>
  function pjax_waline() {
    if(!document.querySelectorAll("#waline")[0])return;
    let pagePlaceholder = pdata.commentPlaceholder || "快来评论吧~";
    let path = pdata.commentPath;
    if (path.length == 0) {
      let defaultPath = '';
      path = defaultPath || decodeURI(window.location.pathname);
    }
    new Waline(Object.assign({"js":"https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js","path":null,"placeholder":"快来评论吧~","imageHosting":"https://7bu.top/api/upload","meta":["nick","mail","link"],"requiredFields":["nick","mail"],"serverURL":"https://yeshan333-waline.vercel.app","avatar":"robohash","pageSize":10,"lang":"zh-CN"}, {
     el: '#waline',
     path: path,
     placeholder: pagePlaceholder,
     uploadImage: function(file) {
      const formData = new FormData();
      formData.append('image', file);
      return fetch('https://7bu.top/api/upload', {
      	method: 'POST',
      	body: formData
      }).then(resp => resp.json()).then(resp => resp.data.url);
   },
  }));
  }
  $(function () {
    pjax_waline();
  });
  volantis.pjax.push(pjax_waline);
</script>




  <script defer src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js" data-pjax></script>



  
<script src="/js/app.js"></script>



<!-- optional -->

  <script>
const SearchServiceimagePath="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@master/img/";
const ROOT =  ("/" || "/").endsWith('/') ? ("/" || "/") : ("//" || "/" );

$('.input.u-search-input').one('focus',function(){
	
		loadScript('https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@2.6.4/js/search.js',setSearchService);
	
})

function listenSearch(){
  
    customSearch = new HexoSearch({
      imagePath: SearchServiceimagePath
    });
  
}
function setSearchService() {
	listenSearch();
	
}
</script>











  <script defer>

  const LCCounter = {
    app_id: 'u9j57bwJod4EDmXWdxrwuqQT-MdYXbMMI',
    app_key: 'jfHtEKVE24j0IVCGHbvuFClp',
    custom_api_server: '',

    // 查询存储的记录
    getRecord(Counter, url, title) {
      return new Promise(function (resolve, reject) {
        Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({url})))
          .then(resp => resp.json())
          .then(({results, code, error}) => {
            if (code === 401) {
              throw error;
            }
            if (results && results.length > 0) {
              var record = results[0];
              resolve(record);
            } else {
              Counter('post', '/classes/Counter', {url, title: title, times: 0})
                .then(resp => resp.json())
                .then((record, error) => {
                  if (error) {
                    throw error;
                  }
                  resolve(record);
                }).catch(error => {
                console.error('Failed to create', error);
                reject(error);
              });
            }
          }).catch((error) => {
          console.error('LeanCloud Counter Error:', error);
          reject(error);
        });
      })
    },

    // 发起自增请求
    increment(Counter, incrArr) {
      return new Promise(function (resolve, reject) {
        Counter('post', '/batch', {
          "requests": incrArr
        }).then((res) => {
          res = res.json();
          if (res.error) {
            throw res.error;
          }
          resolve(res);
        }).catch((error) => {
          console.error('Failed to save visitor count', error);
          reject(error);
        });
      });
    },

    // 构建自增请求体
    buildIncrement(objectId) {
      return {
        "method": "PUT",
        "path": `/1.1/classes/Counter/${ objectId }`,
        "body": {
          "times": {
            '__op': 'Increment',
            'amount': 1
          }
        }
      }
    },

    // 校验是否为有效的 UV
    validUV() {
      var key = 'LeanCloudUVTimestamp';
      var flag = localStorage.getItem(key);
      if (flag) {
        // 距离标记小于 24 小时则不计为 UV
        if (new Date().getTime() - parseInt(flag) <= 86400000) {
          return false;
        }
      }
      localStorage.setItem(key, new Date().getTime().toString());
      return true;
    },

    addCount(Counter) {
      var enableIncr = '' === 'true' && window.location.hostname !== 'localhost';
      enableIncr = true;
      var getterArr = [];
      var incrArr = [];
      // 请求 PV 并自增
      var pvCtn = document.querySelector('#lc-sv');
      if (pvCtn || enableIncr) {
        var pvGetter = this.getRecord(Counter, 'https://yeshan333.github.io' + '/#lc-sv', 'Visits').then((record) => {
          incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-sv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + 1;
              if (pvCtn) {
                pvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(pvGetter);
      }

      // 请求 UV 并自增
      var uvCtn = document.querySelector('#lc-uv');
      if (uvCtn || enableIncr) {
        var uvGetter = this.getRecord(Counter, 'https://yeshan333.github.io' + '/#lc-uv', 'Visitors').then((record) => {
          var vuv = this.validUV();
          vuv && incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-uv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + (vuv ? 1 : 0);
              if (uvCtn) {
                uvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(uvGetter);
      }

      // 请求文章的浏览数，如果是当前页面就自增
      var allPV = document.querySelectorAll('#lc-pv');
      if (allPV.length > 0 || enableIncr) {
        for (i = 0; i < allPV.length; i++) {
          let pv = allPV[i];
          let title = pv.getAttribute('data-title');
          var url = 'https://yeshan333.github.io' + pv.getAttribute('data-path');
          if (url) {
            var viewGetter = this.getRecord(Counter, url, title).then((record) => {
              // 是当前页面就自增
              let curPath = window.location.pathname;
              if (curPath.includes('index.html')) {
                curPath = curPath.substring(0, curPath.lastIndexOf('index.html'));
              }
              if (pv.getAttribute('data-path') == curPath) {
                incrArr.push(this.buildIncrement(record.objectId));
              }
              if (pv) {
                var ele = pv.querySelector('#lc-pv #number');
                if (ele) {
                  if (pv.getAttribute('data-path') == curPath) {
                    ele.innerText = (record.times || 0) + 1;
                  } else {
                    ele.innerText = record.times || 0;
                  }
                  pv.style.display = 'inline';
                }
              }
            });
            getterArr.push(viewGetter);
          }
        }
      }

      // 如果启动计数自增，批量发起自增请求
      if (enableIncr) {
        Promise.all(getterArr).then(() => {
          incrArr.length > 0 && this.increment(Counter, incrArr);
        })
      }

    },


    fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${ api_server }/1.1${ url }`, {
          method,
          headers: {
            'X-LC-Id': this.app_id,
            'X-LC-Key': this.app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      this.addCount(Counter);
    },

    refreshCounter() {
      var api_server = this.app_id.slice(-9) !== '-MdYXbMMI' ? this.custom_api_server : `https://${ this.app_id.slice(0, 8).toLowerCase() }.api.lncldglobal.com`;
      if (api_server) {
        this.fetchData(api_server);
      } else {
        fetch('https://app-router.leancloud.cn/2/route?appId=' + this.app_id)
          .then(resp => resp.json())
          .then(({api_server}) => {
            this.fetchData('https://' + api_server);
          });
      }
    }

  };

  LCCounter.refreshCounter();

  document.addEventListener('pjax:complete', function () {
    LCCounter.refreshCounter();
  });
</script>




  <script>
const rootElement = document.documentElement;
const darkModeStorageKey = "user-color-scheme";
const rootElementDarkModeAttributeName = "data-user-color-scheme";

const setLS = (k, v) => {
    localStorage.setItem(k, v);
};

const removeLS = (k) => {
    localStorage.removeItem(k);
};

const getLS = (k) => {
    return localStorage.getItem(k);
};

const getModeFromCSSMediaQuery = () => {
  return window.matchMedia("(prefers-color-scheme: dark)").matches
    ? "dark"
    : "light";
};

const resetRootDarkModeAttributeAndLS = () => {
  rootElement.removeAttribute(rootElementDarkModeAttributeName);
  removeLS(darkModeStorageKey);
};

const validColorModeKeys = {
  dark: true,
  light: true,
};

const applyCustomDarkModeSettings = (mode) => {
  const currentSetting = mode || getLS(darkModeStorageKey);

  if (currentSetting === getModeFromCSSMediaQuery()) {
    resetRootDarkModeAttributeAndLS();
  } else if (validColorModeKeys[currentSetting]) {
    rootElement.setAttribute(rootElementDarkModeAttributeName, currentSetting);
  } else {
    resetRootDarkModeAttributeAndLS();
  }
};

const invertDarkModeObj = {
  dark: "light",
  light: "dark",
};

/**
 * get target mode
 */
const toggleCustomDarkMode = () => {
  let currentSetting = getLS(darkModeStorageKey);

  if (validColorModeKeys[currentSetting]) {
    currentSetting = invertDarkModeObj[currentSetting];
  } else if (currentSetting === null) {
    currentSetting = invertDarkModeObj[getModeFromCSSMediaQuery()];
  } else {
    return;
  }
  setLS(darkModeStorageKey, currentSetting);
  return currentSetting;
};

/**
 * bind click event for toggle button
 */
var btn=$("#wrapper .toggle-mode-btn,#rightmenu-wrapper .toggle-mode-btn");
function bindToggleButton() {
    btn.on('click',(e) => {
      const mode = toggleCustomDarkMode();
      applyCustomDarkModeSettings(mode);
    });
}

applyCustomDarkModeSettings();
document.addEventListener("DOMContentLoaded", bindToggleButton);
volantis.pjax.push(bindToggleButton);
volantis.pjax.send(()=>{
	btn.unbind('click');
},'toggle-mode-btn-unbind');
</script>








<script>
function listennSidebarTOC() {
  const navItems = document.querySelectorAll(".toc li");
  if (!navItems.length) return;
  const sections = [...navItems].map((element) => {
    const link = element.querySelector(".toc-link");
    const target = document.getElementById(
      decodeURI(link.getAttribute("href")).replace("#", "")
    );
    link.addEventListener("click", (event) => {
      event.preventDefault();
      window.scrollTo({
		top: target.offsetTop + 100,
		
		behavior: "smooth"
		
	  });
    });
    return target;
  });

  function activateNavByIndex(target) {
    if (target.classList.contains("active-current")) return;

    document.querySelectorAll(".toc .active").forEach((element) => {
      element.classList.remove("active", "active-current");
    });
    target.classList.add("active", "active-current");
    let parent = target.parentNode;
    while (!parent.matches(".toc")) {
      if (parent.matches("li")) parent.classList.add("active");
      parent = parent.parentNode;
    }
  }

  function findIndex(entries) {
    let index = 0;
    let entry = entries[index];
    if (entry.boundingClientRect.top > 0) {
      index = sections.indexOf(entry.target);
      return index === 0 ? 0 : index - 1;
    }
    for (; index < entries.length; index++) {
      if (entries[index].boundingClientRect.top <= 0) {
        entry = entries[index];
      } else {
        return sections.indexOf(entry.target);
      }
    }
    return sections.indexOf(entry.target);
  }

  function createIntersectionObserver(marginTop) {
    marginTop = Math.floor(marginTop + 10000);
    let intersectionObserver = new IntersectionObserver(
      (entries, observe) => {
        let scrollHeight = document.documentElement.scrollHeight + 100;
        if (scrollHeight > marginTop) {
          observe.disconnect();
          createIntersectionObserver(scrollHeight);
          return;
        }
        let index = findIndex(entries);
        activateNavByIndex(navItems[index]);
      },
      {
        rootMargin: marginTop + "px 0px -100% 0px",
        threshold: 0,
      }
    );
    sections.forEach((element) => {
      element && intersectionObserver.observe(element);
    });
  }
  createIntersectionObserver(document.documentElement.scrollHeight);
}

document.addEventListener("DOMContentLoaded", listennSidebarTOC);
document.addEventListener("pjax:success", listennSidebarTOC);
</script>

<!-- more -->

  
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yeshan333/jsDelivrCDN/piao.js" />

  <script type="text/javascript" src="https://cdn.staticfile.org/jquery/1.7.2/jquery.min.js" />

  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yeshan333/jsDelivrCDN/attatkmouse.js" />

  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yeshan333/jsDelivrCDN/clearbit.js" />

  <script async defer data-domain="shansan.top" src="https://plausible.io/js/plausible.js" />



 
	  
    </div>
  </body>
</html>
