
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>the-solution-of-elixir-continuous-runtime-system-code-coverage-collection - ShanSan</title>

  
    <meta name="description" content="zh_hans  Code coverage is an effective means to assist software engineers in verifying code quality. The runtime environmentâ€™s ability to collect code coverage fully combines black and white box test">
<meta property="og:type" content="article">
<meta property="og:title" content="the-solution-of-elixir-continuous-runtime-system-code-coverage-collection">
<meta property="og:url" content="https://shansan.top/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/">
<meta property="og:site_name" content="ShanSan">
<meta property="og:description" content="zh_hans  Code coverage is an effective means to assist software engineers in verifying code quality. The runtime environmentâ€™s ability to collect code coverage fully combines black and white box test">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/java_bytecode_tecs.png">
<meta property="og:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/beam_file_format.png">
<meta property="og:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/ex_source_ast_code_mapper.png">
<meta property="og:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/Elixir-Compilation.jpg">
<meta property="og:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/swords.jpg">
<meta property="og:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage_system.jpg">
<meta property="og:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage-arch.jpg">
<meta property="article:published_time" content="2022-08-31T22:43:10.000Z">
<meta property="article:modified_time" content="2022-08-31T22:43:10.000Z">
<meta property="article:author" content="ShanSan">
<meta property="article:tag" content="Elixir">
<meta property="article:tag" content="Test Coverage">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/java_bytecode_tecs.png">
  
  
  
  <meta name="keywords" content="run-time system test coverage">

  <!-- feed -->
  
    <link rel="alternate" href="/rss2.xml" title="ShanSan" type="application/rss+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  
    <link rel="shortcut icon" href="https://s1.ax1x.com/2022/10/09/xJ7yMF.png">
  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ShanSan","sameAs":[]},"dateCreated":"2022-08-31T22:43:10+00:00","dateModified":"2022-08-31T22:43:10+00:00","datePublished":"2022-08-31T22:43:10+00:00","description":"","headline":"the-solution-of-elixir-continuous-runtime-system-code-coverage-collection","mainEntityOfPage":{"@type":"WebPage","@id":"https://shansan.top/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/"},"publisher":{"@type":"Organization","name":"ShanSan","sameAs":[]},"url":"https://shansan.top/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/","keywords":"Elixir, Test Coverage","thumbnailUrl":"https://s1.ax1x.com/2022/11/04/xO9340.png","image":1}</script>
  
</head>
<body>

<div class="l_body content" id="start" layout="post" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://ospy.shan333.cn/blog/blog.avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main">ShanSan</div><div class="sub cap">ä¸ªäººåšå®¢</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="åšæ–‡" href="/archives/"><span>åšæ–‡</span></a><a class="nav-item" title="å…³äº" href="/about/"><span>å…³äº</span></a><a class="nav-item" title="å‹é“¾" href="/friends/"><span>å‹é“¾</span></a><a class="nav-item" title="Bio" href="/wiki/bio/"><span>Bio</span></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div>



<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">æœ€è¿‘æ›´æ–°</span></div><div class="widget-body fs14"><a class="item title" href="/2025/08/09/gen-slides-like-docs-site-with-iflow-cli/"><span class="title">ä½¿ç”¨ iFLOW-CLI GitHub Action ç»™ GitHub ä»“åº“ç”Ÿæˆå¹»ç¯ç‰‡é£æ ¼çš„æ–‡æ¡£ç«™ç‚¹</span></a><a class="item title" href="/2025/07/27/claude-code-subagent-for-tech-writing/"><span class="title">ä½¿ç”¨ Claude Code çš„è‡ªå®šä¹‰ Sub Agent å®Œå–„åšæ–‡å†™ä½œä½“éªŒ</span></a><a class="item title" href="/2025/07/27/migrate-theme-to-stellar-with-claude-code/"><span class="title">ä½¿ç”¨ Claude Code å’Œ Qwen3 Coder å°†åšå®¢ä¸»é¢˜æˆåŠŸè¿ç§»åˆ°äº† Stellar ğŸ‰</span></a><a class="item title" href="/2025/07/12/rss-summary-workflow-with-n8n/"><span class="title">ä½¿ç”¨ n8n å’Œé£ä¹¦å¤šç»´è¡¨æ‰“é€ è‡ªå·±çš„ RSS Feed è®¢é˜…ç®¡ç† & AI å¤§æ¨¡å‹é˜…è¯»æç‚¼å·¥ä½œæµ</span></a><a class="item title" href="/2025/04/20/use-github-copilot-to-create-rsshub-route/"><span class="title">ã€ä½“éªŒã€‘ä½¿ç”¨ GitHub Copilot Agent åˆ›å»ºæ–°çš„ RSSHub è·¯ç”±</span></a><a class="item title" href="/2025/03/23/build-agent-with-mcp-agent-and-qwen/"><span class="title">ä½¿ç”¨ mcp-agent æ¡†æ¶å’Œç™¾ç‚¼é€šä¹‰åƒé—®å¤§æ¨¡å‹æ„å»ºåŸºäº MCP åè®®çš„ç½‘é¡µæ€»ç»“æ™ºèƒ½ä»£ç† (agent)</span></a><a class="item title" href="/2025/02/06/mongodb-deployment-with-tls-and-mkcert/"><span class="title">ä½¿ç”¨ mkcert æœ¬åœ°éƒ¨ç½²å¯åŠ¨äº† TLS/SSL åŠ å¯†é€šè®¯çš„ MongoDB å‰¯æœ¬é›†å’Œåˆ†ç‰‡é›†ç¾¤</span></a><a class="item title" href="/2025/01/08/debug-emscripten-wasm-in-vscode/"><span class="title">åœ¨ Visual Studio Code ä¸å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è°ƒè¯•ä½¿ç”¨ emscripten åŸºäº C ç”Ÿæˆçš„ WASM ä»£ç </span></a><a class="item title" href="/2024/06/18/install-erlang-and-elixir-via-vfox-on-windows/"><span class="title">(Amazing!) é€šè¿‡ vfox åœ¨ Windows ä¸Šå®‰è£…ç®¡ç†å¤šä¸ª Erlang/OTP å’Œ Elixir çš„ç‰ˆæœ¬</span></a><a class="item title" href="/2024/05/29/free-to-use-sider-with-qwen/"><span class="title">æ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•åœ¨ Sider (ChatGPT Sidebar) ä¸­å…è´¹ä½¿ç”¨é€šä¹‰åƒé—®</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="mailto:1329441308@qq.com" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 64C150 64 64 150 64 256s86 192 192 192c17.7 0 32 14.3 32 32s-14.3 32-32 32C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256v32c0 53-43 96-96 96c-29.3 0-55.6-13.2-73.2-33.9C320 371.1 289.5 384 256 384c-70.7 0-128-57.3-128-128s57.3-128 128-128c27.9 0 53.7 8.9 74.7 24.1c5.7-5 13.1-8.1 21.3-8.1c17.7 0 32 14.3 32 32v80 32c0 17.7 14.3 32 32 32s32-14.3 32-32V256c0-106-86-192-192-192zm64 192a64 64 0 1 0 -128 0 64 64 0 1 0 128 0z"/></svg></a><a class="social" href="https://github.com/yeshan333?tab=repositories" target="_blank" rel="external nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></a><a class="social" href="https://music.163.com/#/my/m/music/playlist?id=2617691792" target="_blank" rel="external nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>NetEase Music</title><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></a><a class="social" href="https://www.zhihu.com/people/si-kong-ji-54/activities" target="_blank" rel="external nofollow noopener noreferrer"><svg fill="#18abdc" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg" stroke="#18abdc"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><title>Zhihu icon</title><path d="M5.721 0C2.251 0 0 2.25 0 5.719V18.28C0 21.751 2.252 24 5.721 24h12.56C21.751 24 24 21.75 24 18.281V5.72C24 2.249 21.75 0 18.281 0zm1.964 4.078c-.271.73-.5 1.434-.68 2.11h4.587c.545-.006.445 1.168.445 1.171H9.384a58.104 58.104 0 01-.112 3.797h2.712c.388.023.393 1.251.393 1.266H9.183a9.223 9.223 0 01-.408 2.102l.757-.604c.452.456 1.512 1.712 1.906 2.177.473.681.063 2.081.063 2.081l-2.794-3.382c-.653 2.518-1.845 3.607-1.845 3.607-.523.468-1.58.82-2.64.516 2.218-1.73 3.44-3.917 3.667-6.497H4.491c0-.015.197-1.243.806-1.266h2.71c.024-.32.086-3.254.086-3.797H6.598c-.136.406-.158.447-.268.753-.594 1.095-1.603 1.122-1.907 1.155.906-1.821 1.416-3.6 1.591-4.064.425-1.124 1.671-1.125 1.671-1.125zM13.078 6h6.377v11.33h-2.573l-2.184 1.373-.401-1.373h-1.219zm1.313 1.219v8.86h.623l.263.937 1.455-.938h1.456v-8.86z"></path></g></svg></a><a class="social" href="/rss2.xml" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm0 120a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/></svg></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">æ–‡ç« </a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/Elixir/">Elixir</a></div>
<div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2022-08-31T22:43:10.000Z">2022-08-31</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2022-08-31T22:43:10.000Z">2022-08-31</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>the-solution-of-elixir-continuous-runtime-system-code-coverage-collection</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app/blob/main/examples/README_cn.md">zh_hans</a></p>
</blockquote>
<p>Code coverage is an effective means to assist software engineers in verifying code quality. The runtime environmentâ€™s ability to collect code coverage fully combines black and white box testing capabilities and greatly increases engineersâ€™ confidence in software quality. This article introduces a solution for code coverage collection in the Elixir runtime environment, and provides an in-depth insight into its internal principles.</p>
<h2 id="1.-brief-talk-on-code-coverage" tabindex="-1">1. Brief talk on code coverage</h2>
<p>As a <a target="_blank" rel="noopener" href="https://hvitis.dev/google-qa-testing-article-on-manual-and-automation-test-engineers-sdet">SDET</a> or a SWE, we often need to write unit tests or integration test cases to verify the correctness of the system/application, but at the same time we often question whether our tests are adequate. At this time, test coverage is a means of measuring the adequacy of our testing, enhancing the success rate and confidence of the software release, and giving us more reflective perspectives. The note of the value is that high code coverage does not indicate high code quality, but conversely, code coverage is low, and code quality will not be high.</p>
<p>Most programming languages come with the ability to collect unit test coverage, and the same is true for Elixir, the official <a target="_blank" rel="noopener" href="https://hexdocs.pm/mix/1.13.4/Mix.Tasks.Test.html#module-coverage">mix</a> build tool comes with the ability to collect coverage, but it is currently only suitable for offline system, not for runtime system. This article will be based on Erlangâ€™s cover module to give a solution for the Elixir runtime system. Since <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/cover.html">cover</a> is Erlangâ€™s built-in module, but why it works equally well with Elixir, weâ€™ll unveil its mystery in a follow-up. Before we get started, letâ€™s take a look at the two mainstream ways in which the open source community collects code coverage at runtime (here we look at the bytecode stubbing method of Java, which has a huge ecosystem of the language community):</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/java_bytecode_tecs.png" alt="java_bytecode_tecs"></p>
<p>Next letâ€™s focus on the core of elixir runtime coverage collection in this article - the cover module.</p>
<h2 id="2.-delve-into-the-erlang-cover-coverage-collection-implementation-mechanism" tabindex="-1">2. Delve into the Erlang Cover coverage collection implementation mechanism</h2>
<h3 id="2.1.-introduction-erlang-cover" tabindex="-1">2.1. Introduction Erlang Cover</h3>
<p><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/cover.html">cover</a> is part of Erlangâ€™s built-in tools set, providing a powerful ability to collect code coverage.</p>
<h3 id="2.2.-erlang-code-coverage-collection-implementation-analysis" tabindex="-1">2.2. Erlang code coverage collection implementation analysis</h3>
<p>As you can see from Erlangâ€™s official manual of the cover module, cover counts the number of times every executable line in the Erlang program is executed.</p>
<p>From the introduction of the official documentation, cover can be used for code coverage collection of the runtime system. When the code is instrumented, it does not modify the code source files of any modules or the beam files generated after compilation (that is the industry calls the On-The-Fly mode). Every time the executable row is called, the runtime system updates the number of calls to cover in an in-memory database (erlang ets) for storing data for subsequent coverage analysis.</p>
<p>Next, weâ€™ll explore the details of the On-The-Fly mode under cover.</p>
<h3 id="2.3.-learn-about-beam-file-format" tabindex="-1">2.3. Learn about BEAM File Format</h3>
<p>Before we can further understand the details of the cover implementation, it is necessary to understand the format of the BEAM file after the elixir source code is compiled. The compiled product of the Elixir (.ex file), like the Erlang (.erl file), is a binary chunked file, which is divided into several sections to store information used when the program runs (such as virtual machine operation instructions). In Erlang/Elixir, each module will have a corresponding BEAM file. The approximate structure of the BEAM file is as follows:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/beam_file_format.png" alt="beam_file_format"></p>
<p>Letâ€™s take a look at the approximate content of the beam file through an Elixir mini <a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app">demo</a> project:</p>
<ul>
<li>Step 1. Clone the project <a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app">yeshan333/explore_ast_app</a> to the local:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/yeshan333/explore_ast_app.git</span><br><span class="line">cd explore_ast_app</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 2. Build this project in <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/design_principles/release_structure.html">OTP release format</a>. (note: Elixir and Erlang need to be installed locally):</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MIX_ENV=prod mix distillery.release</span><br></pre></td></tr></table></figure>
<p>It can be noted that each Elixir module is compiled into a BEAM file (can be seen in the directory <code>_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin</code>).</p>
<ul>
<li>Step 3. Next, letâ€™s view the chunks in the Beam file through Erlangâ€™s standard library <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/beam_lib.html#">beam_lib</a>:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">open the iex console</span></span><br><span class="line">iex -S mix</span><br></pre></td></tr></table></figure>
<p>View all chunks of the compiled BEAM file (<code>Elixir.ExploreAstApp.beam</code>):</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>iex -S mix</span><br><span class="line"><span class="title class_">Erlang</span>/<span class="title class_">OTP</span> <span class="number">24</span> [erts<span class="number">-12.1</span>] [source] [<span class="number">64</span>-bit] [<span class="symbol">smp:</span><span class="number">12</span><span class="symbol">:</span><span class="number">12</span>] [<span class="symbol">ds:</span><span class="number">12</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">10</span>] [async-<span class="symbol">threads:</span><span class="number">1</span>] [jit] [dtrace]</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interactive</span> <span class="title class_">Elixir</span> (<span class="number">1.12</span>.<span class="number">3</span>) - press <span class="title class_">Ctrl</span>+C to exit (type h() <span class="title class_">ENTER</span> <span class="keyword">for</span> help)</span><br><span class="line">iex(<span class="number">1</span>)&gt; beam_file_path = <span class="string">&quot;_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin/Elixir.ExploreAstApp.beam&quot;</span></span><br><span class="line"><span class="string">&quot;_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin/Elixir.ExploreAstApp.beam&quot;</span></span><br><span class="line">iex(<span class="number">2</span>)&gt; all_chunks = <span class="symbol">:beam_lib</span>.all_chunks(<span class="title class_">String</span>.to_charlist(beam_file_path))</span><br><span class="line">&#123;<span class="symbol">:ok</span>, <span class="title class_">ExploreAstApp</span>,</span><br><span class="line"> [</span><br><span class="line">   &#123;<span class="string">&#x27;AtU8&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">69</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">105</span>, <span class="number">114</span>, <span class="number">46</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">112</span>, <span class="number">108</span>, <span class="number">111</span>,</span><br><span class="line">      <span class="number">114</span>, <span class="number">101</span>, <span class="number">65</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">65</span>, <span class="number">112</span>, <span class="number">112</span>, <span class="number">8</span>, <span class="number">95</span>, <span class="number">95</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">102</span>, <span class="number">111</span>, <span class="number">95</span>,</span><br><span class="line">      <span class="number">95</span>, <span class="number">10</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">98</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">101</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Code&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">169</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">16</span>,</span><br><span class="line">      <span class="number">153</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">18</span>, <span class="number">34</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="number">32</span>, <span class="number">59</span>, <span class="number">3</span>, <span class="number">21</span>, <span class="number">23</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">50</span>, <span class="number">117</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">82</span>,</span><br><span class="line">      <span class="number">101</span>, <span class="number">98</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;StrT&#x27;</span>, <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;ImpT&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">      <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;ExpT&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;LitT&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">120</span>, <span class="number">156</span>, <span class="number">99</span>, <span class="number">96</span>, <span class="number">96</span>, <span class="number">96</span>, <span class="number">98</span>, <span class="number">96</span>, <span class="number">96</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">206</span>, <span class="number">1</span>, <span class="number">146</span>,</span><br><span class="line">      <span class="number">140</span>, <span class="number">25</span>, <span class="number">76</span>, <span class="number">229</span>, <span class="number">172</span>, <span class="number">25</span>, <span class="number">169</span>, <span class="number">57</span>, <span class="number">57</span>, <span class="number">249</span>, <span class="number">137</span>, <span class="number">12</span>, <span class="number">89</span>, <span class="number">64</span>, <span class="number">190</span>, <span class="number">88</span>,</span><br><span class="line">      <span class="number">115</span>, <span class="number">46</span>, <span class="number">144</span>, <span class="number">20</span>, <span class="number">248</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;LocT&#x27;</span>, &lt;&lt;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Attr&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">108</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">118</span>, <span class="number">115</span>, <span class="number">110</span>, <span class="number">108</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">      <span class="number">110</span>, <span class="number">16</span>, <span class="number">0</span>, <span class="number">165</span>, <span class="number">236</span>, <span class="number">94</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">160</span>, <span class="number">184</span>, <span class="number">33</span>, <span class="number">240</span>, <span class="number">28</span>, <span class="number">89</span>, <span class="number">11</span>, <span class="number">22</span>, <span class="number">130</span>,</span><br><span class="line">      <span class="number">207</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;CInf&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">108</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">118</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">111</span>,</span><br><span class="line">      <span class="number">110</span>, <span class="number">107</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">56</span>, <span class="number">46</span>, <span class="number">48</span>, <span class="number">46</span>, <span class="number">51</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">111</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>,</span><br><span class="line">      <span class="number">111</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Dbgi&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">143</span>, <span class="number">120</span>, <span class="number">156</span>, <span class="number">117</span>, <span class="number">80</span>, <span class="number">203</span>, <span class="number">78</span>, <span class="number">3</span>, <span class="number">49</span>, <span class="number">12</span>, <span class="number">76</span>, <span class="number">233</span>, <span class="number">67</span>,</span><br><span class="line">      <span class="number">162</span>, <span class="number">5</span>, <span class="number">113</span>, <span class="number">65</span>, <span class="number">124</span>, <span class="number">70</span>, <span class="number">87</span>, <span class="number">253</span>, <span class="number">2</span>, <span class="number">212</span>, <span class="number">67</span>, <span class="number">63</span>, <span class="number">129</span>, <span class="number">115</span>, <span class="number">148</span>, <span class="number">221</span>,</span><br><span class="line">      <span class="number">120</span>, ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Docs&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">241</span>, <span class="number">120</span>, <span class="number">156</span>, <span class="number">93</span>, <span class="number">142</span>, <span class="number">205</span>, <span class="number">10</span>, <span class="number">194</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">132</span>, <span class="number">215</span>,</span><br><span class="line">      <span class="number">74</span>, <span class="number">91</span>, <span class="number">9</span>, <span class="number">248</span>, <span class="number">14</span>, <span class="number">129</span>, <span class="number">94</span>, <span class="number">244</span>, <span class="number">82</span>, <span class="number">241</span>, <span class="number">234</span>, <span class="number">65</span>, <span class="number">40</span>, <span class="number">88</span>, <span class="number">241</span>, <span class="number">45</span>, <span class="number">108</span>,</span><br><span class="line">      ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;ExCk&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">131</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">105</span>, <span class="number">114</span>, <span class="number">95</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">101</span>,</span><br><span class="line">      <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">95</span>, <span class="number">118</span>, <span class="number">49</span>, <span class="number">116</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">101</span>, <span class="number">120</span>,</span><br><span class="line">      ...&gt;&gt;&#125;,</span><br><span class="line">   &#123;<span class="string">&#x27;Line&#x27;</span>,</span><br><span class="line">    &lt;&lt;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">18</span>, <span class="number">241</span>, <span class="number">0</span>,</span><br><span class="line">      <span class="number">22</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">98</span>, <span class="number">47</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">112</span>, <span class="number">108</span>, ...&gt;&gt;&#125;</span><br><span class="line"> ]&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, the obtained chunks correspond to the previous diagram. We can also obtain the Erlang AST (abstract syntax tree) corresponding to the module (<code>ExploreAstApp</code>) through the beam_lib standard library:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">3</span>)&gt; result = <span class="symbol">:beam_lib</span>.chunks(<span class="title class_">String</span>.to_charlist(beam_file_path), [<span class="symbol">:abstract_code</span>])</span><br><span class="line">&#123;<span class="symbol">:ok</span>,</span><br><span class="line"> &#123;<span class="title class_">ExploreAstApp</span>,</span><br><span class="line">  [</span><br><span class="line">    <span class="symbol">abstract_code:</span> &#123;<span class="symbol">:raw_abstract_v1</span>,</span><br><span class="line">     [</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:file</span>, &#123;<span class="string">&#x27;lib/explore_ast_app.ex&#x27;</span>, <span class="number">1</span>&#125;&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:module</span>, <span class="title class_">ExploreAstApp</span>&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:compile</span>, [<span class="symbol">:no_auto_import</span>]&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:export</span>, [<span class="symbol">__info__:</span> <span class="number">1</span>, <span class="symbol">hello:</span> <span class="number">0</span>]&#125;,</span><br><span class="line">       &#123;<span class="symbol">:attribute</span>, <span class="number">1</span>, <span class="symbol">:spec</span>,</span><br><span class="line">        &#123;&#123;<span class="symbol">:__info__</span>, <span class="number">1</span>&#125;,</span><br><span class="line">         [</span><br><span class="line">           &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:fun</span>,</span><br><span class="line">            [</span><br><span class="line">              &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:product</span>,</span><br><span class="line">               [</span><br><span class="line">                 &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:union</span>,</span><br><span class="line">                  [</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:attributes</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:compile</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:functions</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:macros</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:md5</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:exports_md5</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:module</span>&#125;,</span><br><span class="line">                    &#123;<span class="symbol">:atom</span>, <span class="number">1</span>, <span class="symbol">:deprecated</span>&#125;</span><br><span class="line">                  ]&#125;</span><br><span class="line">               ]&#125;,</span><br><span class="line">              &#123;<span class="symbol">:type</span>, <span class="number">1</span>, <span class="symbol">:any</span>, []&#125;</span><br><span class="line">            ]&#125;</span><br><span class="line">         ]&#125;&#125;,</span><br><span class="line">       &#123;<span class="symbol">:function</span>, <span class="number">0</span>, <span class="symbol">:__info__</span>, <span class="number">1</span>,</span><br><span class="line">        [</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:module</span>&#125;], [], [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="title class_">ExploreAstApp</span>&#125;]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:functions</span>&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:cons</span>, <span class="number">0</span>, &#123;<span class="symbol">:tuple</span>, <span class="number">0</span>, [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:hello</span>&#125;, &#123;<span class="symbol">:integer</span>, <span class="number">0</span>, <span class="number">0</span>&#125;]&#125;,</span><br><span class="line">              &#123;<span class="literal">nil</span>, <span class="number">0</span>&#125;&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:macros</span>&#125;], [], [<span class="symbol">nil:</span> <span class="number">0</span>]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:exports_md5</span>&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:bin</span>, <span class="number">0</span>,</span><br><span class="line">              [</span><br><span class="line">                &#123;<span class="symbol">:bin_element</span>, <span class="number">0</span>,</span><br><span class="line">                 &#123;<span class="symbol">:string</span>, <span class="number">0</span>,</span><br><span class="line">                  [<span class="number">240</span>, <span class="number">105</span>, <span class="number">247</span>, <span class="number">119</span>, <span class="number">22</span>, <span class="number">50</span>, <span class="number">219</span>, <span class="number">207</span>, <span class="number">90</span>, <span class="number">95</span>, <span class="number">127</span>, <span class="number">92</span>, ...]&#125;,</span><br><span class="line">                 <span class="symbol">:default</span>, <span class="symbol">:default</span>&#125;</span><br><span class="line">              ]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:match</span>, <span class="number">0</span>, &#123;<span class="symbol">:var</span>, <span class="number">0</span>, <span class="symbol">:Key</span>&#125;, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:attributes</span>&#125;&#125;],</span><br><span class="line">           [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:call</span>, <span class="number">0</span>,</span><br><span class="line">              &#123;<span class="symbol">:remote</span>, <span class="number">0</span>, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:erlang</span>&#125;, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:get_module_info</span>&#125;&#125;,</span><br><span class="line">              [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="title class_">ExploreAstApp</span>&#125;, &#123;<span class="symbol">:var</span>, <span class="number">0</span>, <span class="symbol">:Key</span>&#125;]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:match</span>, <span class="number">0</span>, &#123;<span class="symbol">:var</span>, <span class="number">0</span>, <span class="symbol">:Key</span>&#125;, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:compile</span>&#125;&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:call</span>, <span class="number">0</span>,</span><br><span class="line">              &#123;<span class="symbol">:remote</span>, <span class="number">0</span>, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:erlang</span>&#125;, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:get_module_info</span>&#125;&#125;,</span><br><span class="line">              [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="title class_">ExploreAstApp</span>&#125;, &#123;<span class="symbol">:var</span>, <span class="number">0</span>, <span class="symbol">:Key</span>&#125;]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:match</span>, <span class="number">0</span>, &#123;<span class="symbol">:var</span>, <span class="number">0</span>, <span class="symbol">:Key</span>&#125;, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:md5</span>&#125;&#125;], [],</span><br><span class="line">           [</span><br><span class="line">             &#123;<span class="symbol">:call</span>, <span class="number">0</span>,</span><br><span class="line">              &#123;<span class="symbol">:remote</span>, <span class="number">0</span>, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:erlang</span>&#125;, &#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:get_module_info</span>&#125;&#125;,</span><br><span class="line">              [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="title class_">ExploreAstApp</span>&#125;, &#123;<span class="symbol">:var</span>, <span class="number">0</span>, <span class="symbol">:Key</span>&#125;]&#125;</span><br><span class="line">           ]&#125;,</span><br><span class="line">          &#123;<span class="symbol">:clause</span>, <span class="number">0</span>, [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:deprecated</span>&#125;], [], [<span class="symbol">nil:</span> <span class="number">0</span>]&#125;</span><br><span class="line">        ]&#125;,</span><br><span class="line">       &#123;<span class="symbol">:function</span>, <span class="number">15</span>, <span class="symbol">:hello</span>, <span class="number">0</span>, [&#123;<span class="symbol">:clause</span>, <span class="number">15</span>, [], [], [&#123;<span class="symbol">:atom</span>, <span class="number">0</span>, <span class="symbol">:world</span>&#125;]&#125;]&#125;</span><br><span class="line">     ]&#125;</span><br><span class="line">  ]&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>It can be seen that AST is expressed in the form of <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/reference_manual/data_types.html#terms">Erlang Terms</a> (called Abstract Code), which is easy to read. The Abstract Code is very useful in the on-the-fly instrumentation process of cover.</p>
<p>The above AST structure is simple and easy to read, and we can easily match it with the source code (<code>lib/explore_ast_app.ex</code>) before the module is compiled, although the AST structure is the final Erlang AST, and some extras information are added by the Erlang compiler, but does not affect reading:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/ex_source_ast_code_mapper.png" alt="ex_source_ast_code_mapper"></p>
<p>The second element in the tuple generally represents the number of source code lines. You can learn more about Erlangâ€™s Abstract Format through the official documentation. By observing the Erlang AST structure of several BEAM files, you will be familiar with it. It is worth noting that the Abstract Code was stored in the Abstract Chunk of the BEAM file before OTP 20.</p>
<p>If you want to learn more about BEAM files in detail, you can check out the following two documents:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://beam-wisdoms.clau.se/en/latest/indepth-beam-file.html#beam-term-format">http://beam-wisdoms.clau.se/en/latest/indepth-beam-file.html#beam-term-format</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stenmans.org/theBeamBook/#BEAM_files">https://blog.stenmans.org/theBeamBook/#BEAM_files</a></li>
</ul>
<h3 id="2.4.-elixir-source-code-compilation-process" tabindex="-1">2.4. Elixir source code compilation process</h3>
<p>After understanding BEAM File Format, we also need to understand the compilation process of Elixir code, which will help us better understand cover. The process of compiling Elixir source code into BEAM file may not be as you imagined In the same way, instead of directly from Elixirâ€™s AST, it becomes executable BEAM Code after being processed by the compiler backend. There is also a process in the middle, as shown in the following figure:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/Elixir-Compilation.jpg" alt="Elixir-Compilation-Process"></p>
<p>The above process can be described as:</p>
<ul>
<li>
<p>Step 1ã€The Elixir source code will be parsed by a custom lexical analyzer (<a target="_blank" rel="noopener" href="https://github.com/elixir-lang/elixir/blob/main/lib/elixir/src/elixir_tokenizer.erl">elixir_tokenizer</a>) and <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/yecc.html">yacc</a> to generate the initial version of Elixir AST, which is expressed in the form of Elixir Terms; if you are interested in Elixirâ€™s AST, you can follow this Project <a target="_blank" rel="noopener" href="https://github.com/arjan/ast_ninja">arjan/ast_ninja</a>;</p>
</li>
<li>
<p>Step 2ã€In the Elixir AST stage, some custom and built-in Macros have not been expanded, and these Macros are expanded into the final Elixir AST in the Expanded Elixir AST stage;</p>
</li>
<li>
<p>Step 3ã€Final Elixir AST will be converted into Erlang standard AST form (<a target="_blank" rel="noopener" href="https://www.erlang.org/doc/apps/erts/absform.html">Erlang Abstract Format</a>) after being processed by Elixir Compiler;</p>
</li>
<li>
<p>Step 4ã€Finally, Elixir will use the Erlang Compiler to process the Erlang AST, converting it into BEAM bytecode executable by the BEAM Virtual Machine (VM). For details on the compiler, see: <a target="_blank" rel="noopener" href="https://github.com/elixir-lang/elixir/blob/main/lib/elixir/src/elixir_compiler.erl">elixir_compiler.erl</a> and <a target="_blank" rel="noopener" href="https://github.com/elixir-lang/elixir/blob/main/lib/elixir/src/elixir_erl.erl">elixir_erl.erl</a> source code For more details on the Erlang Compiler, see <a target="_blank" rel="noopener" href="https://blog.stenmans.org/theBeamBook/#CH-Compiler">theBeamBook/#CH-Compiler</a>.</p>
</li>
</ul>
<h3 id="2.5.-cover-on-the-fly-instrumentation-implementation" tabindex="-1">2.5. Cover On-The-Fly Instrumentation Implementation</h3>
<p>Now itâ€™s time for dinner. Letâ€™s see how cover performs instrumentation and coverage collection. To use cover to complete code coverage collection, we must know three dragon-slaying swords:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/swords.jpg" alt="three dragon-slaying swords"></p>
<ul>
<li>
<p><code>cover:start</code>: Used to create the cover coverage collection process, it will complete the creation of the relevant ets table to store the coverage data, <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L159">cover.erl#L159</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L632">cover.erl#L632</a>, and we can also start the cover process of the remote Erlang node.</p>
</li>
<li>
<p><code>cover:compile_beam</code>: For instrumentation, cover will read the content of the abstract_code of the BEAM file, namely Erlang AST. The key code is in <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1541">cover.erl#L1541</a>, and then transform and munge the Erlang AST From, it will call <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1938">bump_call</a>, after each executable line will insert the following abstract_code:</p>
</li>
</ul>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;call,A,&#123;remote,A,&#123;atom,A,ets&#125;,&#123;atom,A,update_counter&#125;&#125;,</span><br><span class="line"> [&#123;atom,A,?COVER_TABLE&#125;,</span><br><span class="line">  &#123;tuple,A,[&#123;atom,A,?BUMP_REC_NAME&#125;,</span><br><span class="line">            &#123;atom,A,Vars#vars.module&#125;,</span><br><span class="line">            &#123;atom,A,Vars#vars.function&#125;,</span><br><span class="line">            &#123;integer,A,Vars#vars.arity&#125;,</span><br><span class="line">            &#123;integer,A,Vars#vars.clause&#125;,</span><br><span class="line">            &#123;integer,A,Line&#125;]&#125;,</span><br><span class="line">  &#123;integer,A,<span class="number">1</span>&#125;]&#125;.</span><br></pre></td></tr></table></figure>
<p>From the previous understanding of Erlang AST, we know that this is equivalent to inserting the following line of code:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ets:update_counter(?COVER_TABLE, #bump&#123;module=Module, function=Function, arity=Arity, clause=Clause, line=Line&#125;, <span class="number">1</span>).</span><br></pre></td></tr></table></figure>
<p>Then for the mungeed Erlang AST Form, cover uses the Erlang Compiler to obtain the Erlang Beam Code (also known as object code. i.e. bytecode, VM execution instructions) from the mungeed AST expression form. <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1580">cover.erl#L1580</a>. And then use the Erlang <a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/code.html#load_binary-3">code server</a> to replace the old object code with the new object code obtained, <code>load_binary</code> <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/blob/2f0a547f78363a2504405e82e3ab3ea35b9e6a88/lib/tools/src/cover.erl#L1581">cover.erl#L1581</a> into <a target="_blank" rel="noopener" href="https://blog.stenmans.org/theBeamBook/#P-ERTS">ERTS</a> (Erlang Run Time System). cover completes the Erlang AST instrumentation process, so that whenever the executable line is Executed, the corresponding ets storage table will update the number of times the code line was called.</p>
<ul>
<li><code>cover:analyze</code>: Analyze the data stored in the ets table to obtain the number of times the executable line was executed (called), which can be used for statistical coverage data.</li>
</ul>
<blockquote>
<p>munge: Used to make a series of potentially destructive or irreversible changes to data or files.</p>
</blockquote>
<h2 id="3.-elixir-application-runtime-coverage-collection-example" tabindex="-1">3. Elixir Application runtime coverage collection example</h2>
<p>Through the above, after understanding the implementation details of the Erlang Cover module. Let us take a deployed and running Elixir Application (we will use the previous <a target="_blank" rel="noopener" href="https://github.com/yeshan333/explore_ast_app">yesan333/explore_ast_app</a>) as an example to perform large-scale tests (system &amp; integration tests) of the Elixir application runtime of code line-level coverage collection.</p>
<p>Here we will use a tool library: <a target="_blank" rel="noopener" href="https://github.com/yeshan333/ex_integration_coveralls">ex_integration_coveralls</a> for coverage analysis, which is an Elixir Wrapper for the Erlang module cover to collection Elixir runtime system coverage. Letâ€™s start:</p>
<ul>
<li>Step 1ã€Add <code>ex_integration_coveralls</code> dependency to <code>mix.exs</code> file:</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">deps</span></span> <span class="keyword">do</span></span><br><span class="line">  [</span><br><span class="line">    ...,</span><br><span class="line">    &#123;<span class="symbol">:ex_integration_coveralls</span>, <span class="string">&quot;~&gt; 0.3.0&quot;</span>&#125;</span><br><span class="line">  ]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Pull the dependencies and rebuild the project:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mix deps.get</span><br><span class="line">MIX_ENV=prod mix distillery.release</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 2ã€Start the project:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_build/prod/rel/explore_ast_app/bin/explore_ast_app foreground</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 3ã€Connect to the remote_console of the Elixir runtime application node:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_build/prod/rel/explore_ast_app/bin/explore_ast_app remote_console</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 4ã€Use <code>ex_integration_coveralls</code> (ExIntegrationCoveralls.execute) to start cover and perform code coverage collection:</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">1</span>&gt; compiled_beam_dir_path = <span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app/_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin&quot;</span></span><br><span class="line"><span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app/_build/prod/rel/explore_ast_app/lib/explore_ast_app-0.1.0/ebin&quot;</span></span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">2</span>&gt; <span class="title class_">ExIntegrationCoveralls</span>.execute(compiled_beam_dir_path)</span><br><span class="line">[</span><br><span class="line">  <span class="symbol">ok:</span> <span class="title class_">ExploreAstApp</span>.<span class="title class_">Router</span>,</span><br><span class="line">  <span class="symbol">ok:</span> <span class="title class_">ExploreAstApp</span>.<span class="title class_">Plug</span>.<span class="title class_">VerifyRequest</span>.<span class="title class_">IncompleteRequestError</span>,</span><br><span class="line">  <span class="symbol">ok:</span> <span class="title class_">ExploreAstApp</span>.<span class="title class_">Plug</span>.<span class="title class_">VerifyRequest</span>,</span><br><span class="line">  <span class="symbol">ok:</span> <span class="title class_">ExploreAstApp</span>.<span class="title class_">Application</span>,</span><br><span class="line">  <span class="symbol">ok:</span> <span class="title class_">ExploreAstApp</span></span><br><span class="line">]</span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">3</span>&gt; compile_time_source_lib_abs_path = <span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line"><span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">4</span>&gt; source_code_abs_path = <span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line"><span class="string">&quot;/Users/yeshan/oss_github/explore_ast_app&quot;</span></span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">5</span>&gt; <span class="title class_">ExIntegrationCoveralls</span>.get_total_coverage(compile_time_source_lib_abs_path, source_code_abs_path)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>As you can see, the initial coverage is 0, because no code has been called yet.</p>
<ul>
<li>Step 5ã€Letâ€™s execute the following cURL. Let code be called:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl --location --request GET <span class="string">&#x27;http://localhost:8080/hello&#x27;</span></span></span><br><span class="line">hello %</span><br></pre></td></tr></table></figure>
<p>Check out the code coverage data again in iex console:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">6</span>&gt; <span class="title class_">ExIntegrationCoveralls</span>.get_total_coverage(compile_time_source_lib_abs_path, source_code_abs_path)</span><br><span class="line"><span class="number">17.1</span></span><br></pre></td></tr></table></figure>
<p>As you can see, the cURL (test case) coverage for this project is 17.1%.</p>
<p>We can also use the following methods to view more detailed code coverage, such as viewing the code coverage of <code>lib/explore_ast_app/router.ex</code> (<code>nil</code> means the line is not an executable line):</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">7</span>&gt; result = <span class="title class_">ExIntegrationCoveralls</span>.get_coverage_report(compile_time_source_lib_abs_path, source_code_abs_path)</span><br><span class="line">.......</span><br><span class="line">iex(explore_ast_app<span class="variable">@127</span>.<span class="number">0.0</span>.<span class="number">1</span>)<span class="number">8</span>&gt; <span class="title class_">Enum</span>.at(<span class="title class_">Map</span>.get(result, <span class="symbol">:files</span>), <span class="number">3</span>)</span><br><span class="line">%<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Source</span>&#123;</span><br><span class="line">  <span class="symbol">coverage:</span> <span class="number">18.2</span>,</span><br><span class="line">  <span class="symbol">filename:</span> <span class="string">&quot;lib/explore_ast_app/router.ex&quot;</span>,</span><br><span class="line">  <span class="symbol">hits:</span> <span class="number">4</span>,</span><br><span class="line">  <span class="symbol">misses:</span> <span class="number">18</span>,</span><br><span class="line">  <span class="symbol">sloc:</span> <span class="number">22</span>,</span><br><span class="line">  <span class="symbol">source:</span> [</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">1</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;defmodule ExploreAstApp.Router do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="number">1</span>, <span class="symbol">source:</span> <span class="string">&quot;  use Plug.Router&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  use Plug.ErrorHandler&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  import Plug.Conn&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  alias ExploreAstApp.Plug.VerifyRequest&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug Plug.Parsers, parsers: [:urlencoded, :multipart]&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug VerifyRequest, fields: [\&quot;content\&quot;, \&quot;mimetype\&quot;], paths: [\&quot;/upload\&quot;]&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  plug :match&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug Plug.Parsers, parsers: [:json], pass: [\&quot;application/json\&quot;], json_decoder: Jason&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  plug :dispatch&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/welcome\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    send_resp(conn, 200, \&quot;Welcome\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/upload\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    send_resp(conn, 201, \&quot;Uploaded\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">1</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/hello\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # query parameter is user like this:&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # http://localhost:4001/hello?name=John&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # which will create %&#123;\&quot;name\&quot; =&gt; \&quot;John\&quot;&#125;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">1</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;      send_resp(conn, 200, \&quot;hello \#&#123;Map.get(conn.query_params, \&quot;name\&quot;)&#125;\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  get \&quot;/hello/:name\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    send_resp(conn, 200, \&quot;hello \#&#123;name&#125;\&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;  end&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;  post \&quot;/hello\&quot; do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # json body of POST request &#123;\&quot;name\&quot;: \&quot;John\&quot;&#125; is parsed to %&#123;\&quot;name\&quot; =&gt; \&quot;John\&quot;&#125;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;    # so it can be accesable with e.g. Map.get(conn.body_params, \&quot;name\&quot;) or with pattern matching&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="number">0</span>, <span class="symbol">source:</span> <span class="string">&quot;    name =&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;      case conn.body_params do&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="number">0</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;        %&#123;\&quot;name\&quot; =&gt; a_name &#125; -&gt; a_name&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;</span><br><span class="line">      <span class="symbol">coverage:</span> <span class="literal">nil</span>,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">&quot;        _ -&gt; \&quot;\&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;      end&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, <span class="symbol">source:</span> <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;<span class="symbol">coverage:</span> <span class="literal">nil</span>, ...&#125;,</span><br><span class="line">    %<span class="title class_">ExIntegrationCoveralls</span>.<span class="title class_">Stats</span>.<span class="title class_">Line</span>&#123;...&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Based on the <code>post_cov_stats_to_ud_ci</code> interface, it is possible to further interface with internal or external <a target="_blank" rel="noopener" href="https://about.codecov.io/">Codecov</a>-like coverage systems.</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage_system.jpg" alt="coverage_system"></p>
<p>Based on this, we can realize the collection of code coverage with large-scale (integration &amp; system) testing capabilities without stopping the Elixir Application.</p>
<h2 id="4.-continuous-runtime-coverage-collection-solution-for-large-scale-elixir%2Ferlang-microservice-clusters" tabindex="-1">4. Continuous runtime coverage collection solution for large-scale Elixir/Erlang Microservice clusters</h2>
<p>With the continuous expansion of the Elixir/Erlang microservice system, the coverage collection method shown in the previous section needs further evolution. Referring to the design of <a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/#architecture">Prometheus Pull-Base</a>, the overall design (combination of Pull &amp; Push mode) is as follows:</p>
<p><img src="https://github.com/yeshan333/explore_ast_app/raw/main/examples/assets/en/coverage-arch.jpg" alt="coverage_system_design"></p>
<p>We expand based on <a target="_blank" rel="noopener" href="https://github.com/yeshan333/ex_integration_coveralls">ex_integration_coveralls</a>. After the Elixir Application is started, a http worker is started up to expose the code coverage data in real time, which is convenient for communication with heterogeneous systems. The Coverage Push Gateway is responsible for regularly pulling the coverage data (Gateway can be a OTP Application, which allows <code>ex_integration_coveralls</code> to directly start up the custom <a target="_blank" rel="noopener" href="https://github.com/yeshan333/ex_integration_coveralls/blob/main/lib/ex_integration_coveralls/cov_stats_worker.ex">GenServer Worker</a> for interactive integration test system in the distributed OTP system), after the integration/system test system informs the end of the test, the Gateway pushes the coverage data to the <code>Cover Center</code> for code coverage rate display.</p>
<p>End (long way to go).</p>
<h2 id="references" tabindex="-1">References</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36f4140541f8dd555fb8aaee2fd719d59ffab041.pdf">Code Coverage at Google</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/cover.html#description">Erlang cover</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/blog/a-brief-beam-primer/">A brief introduction to BEAM</a></li>
<li><a target="_blank" rel="noopener" href="http://gomoripeti.github.io/beam_by_example/">A peak into the Erlang compiler and BEAM bytecode</a></li>
<li><a target="_blank" rel="noopener" href="https://elixirforum.com/t/getting-each-stage-of-elixirs-compilation-all-the-way-to-the-beam-bytecode/1873/5">Getting each stage of Elixirâ€™s compilation all the way to the BEAM bytecode</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/parroty/excoveralls">excoveralls</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hrzndhrn/beam_file">BeamFile - A peek into the BEAM file</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/KronicDeth/intellij-elixir#beam-files">https://github.com/KronicDeth/intellij-elixir#beam-files</a></li>
</ul>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">
</article>
<div class="article-footer">
    <section id="license">
      <div class="header"><span>è®¸å¯åè®®</span></div>
      <div class="body"><p><a href="/wiki/bio/mycat/">å–‚çŒ«ğŸ</a> <br/> This article is licensed under the <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Please provide attribution when reproducing. <br/> æœ¬æ–‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div>
    </section>
    


    <section id="share">
      <div class="header"><span>åˆ†äº«æ–‡ç« </span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://shansan.top/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://shansan.top/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/&title=the-solution-of-elixir-continuous-runtime-system-code-coverage-collection - ShanSan&pics=https://s1.ax1x.com/2022/11/04/xO9340.png&summary=
zh_hans

Code coverage is an effective means to assist software engineers in verifying code quality. The runtime env..."><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg" /></a><a class="social share-item email" href="mailto:?subject=the-solution-of-elixir-continuous-runtime-system-code-coverage-collection - ShanSan&amp;body=https://shansan.top/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;å¤åˆ¶æˆåŠŸ&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://shansan.top/2022/08/31/the-solution-of-elixir-continuous-runtime-system-code-coverage-collection/"/>
        </div>
        
      </div>
    </section>
    </div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/2022/11/26/Elixir-Tip-Case-vs-With/">ï¼ˆè¯‘ï¼‰Elixir Tip: Case vs. With</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/2022/06/29/elixir-run-time-code-line-level-coverage-collection/">Elixir è¿ç»­è¿è¡Œæ—¶ä»£ç è¦†ç›–ç‡é‡‡é›†æ–¹æ¡ˆ</a></div></section></div>

<div class="related-wrap" id="related-posts">
    <section class='header'>
      <div class='title cap theme'>æ‚¨å¯èƒ½æ„Ÿå…´è¶£çš„æ–‡ç« </div>
    </section>
    <section class='body'>
    <div class="related-posts"><a class="item" href="/2022/06/29/elixir-run-time-code-line-level-coverage-collection/" title="Elixir è¿ç»­è¿è¡Œæ—¶ä»£ç è¦†ç›–ç‡é‡‡é›†æ–¹æ¡ˆ"><span class="title">Elixir è¿ç»­è¿è¡Œæ—¶ä»£ç è¦†ç›–ç‡é‡‡é›†æ–¹æ¡ˆ</span></a><a class="item" href="/2022/11/26/Elixir-Tip-Case-vs-With/" title="ï¼ˆè¯‘ï¼‰Elixir Tip: Case vs. With"><span class="title">ï¼ˆè¯‘ï¼‰Elixir Tip: Case vs. With</span></a><a class="item" href="/2023/08/12/elixir-deps-debug-skills/" title="Elixir ä¾èµ– (deps) è°ƒè¯•çš„å°æŠ€å·§"><span class="title">Elixir ä¾èµ– (deps) è°ƒè¯•çš„å°æŠ€å·§</span><span class="excerpt">Elixir ä¾èµ– (deps) è°ƒè¯•çš„å°æŠ€å·§</span></a><a class="item" href="/2024/06/18/install-erlang-and-elixir-via-vfox-on-windows/" title="(Amazing!) é€šè¿‡ vfox åœ¨ Windows ä¸Šå®‰è£…ç®¡ç†å¤šä¸ª Erlang/OTP å’Œ Elixir çš„ç‰ˆæœ¬"><span class="title">(Amazing!) é€šè¿‡ vfox åœ¨ Windows ä¸Šå®‰è£…ç®¡ç†å¤šä¸ª Erlang/OTP å’Œ Elixir çš„ç‰ˆæœ¬</span><span class="excerpt">é€šè¿‡ vfox å®‰è£…åœ¨ Windows ä¸Šç®¡ç†å¤šä¸ª Erlang/OTP å’Œ Elixir çš„ç‰ˆæœ¬</span></a><a class="item" href="/2022/06/18/understanding-elixir-macros-part-1-basics/" title="(è¯‘) Understanding Elixir Macros, Part 1 Basics"><span class="title">(è¯‘) Understanding Elixir Macros, Part 1 Basics</span></a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>ShanSan</p>

    </section>
    <section class='body cmt-body artalk'>
      

<div class="artalk with-fancybox" id="artalk_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><a href="https://shansan.top">Copyright Â© 2018-2025 ShanSan</a><br><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">æ¡‚ICPå¤‡19000444å·</a><br>
æœ¬ç«™ç”± <a href="/">ShanSan</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> ä¸»é¢˜åˆ›å»ºã€‚<br>
æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚<br>
<span id="busuanzi_container_site_pv">æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">
<widget class="widget-wrapper user-card ghuser"><div class="widget-body data-service ds-ghinfo" data-api="https://api.github.com/users/yeshan333"><div class="avatar" ><img no-lazy type="img" id="avatar_url" src="undefined" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><p class="username" type="text" id="name">&nbsp;</p><p class="bio" type="text" id="bio">&nbsp;</p><div class="buttons"><a class="btn" target="_blank" rel="noopener" href="https://github.com/yeshan333?tab=followers"><span class="title" type="text" id="followers">0</span><span class="desc">followers</span></a><a class="btn" target="_blank" rel="noopener" href="https://github.com/yeshan333?tab=following"><span class="title" type="text" id="following">0</span><span class="desc">following</span></a><a class="btn" target="_blank" rel="noopener" href="https://github.com/yeshan333?tab=repositories"><span class="title" type="text" id="public_repos">0</span><span class="desc">repos</span></a></div><a class="follow" target="_blank" rel="noopener" href="https://github.com/yeshan333"><svg aria-hidden="true" role="img" class="color-icon-primary" viewBox="0 0 16 16" width="1em" height="1em" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>Follow</a></div></widget>


<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1.-brief-talk-on-code-coverage"><span class="toc-text">1. Brief talk on code coverage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2.-delve-into-the-erlang-cover-coverage-collection-implementation-mechanism"><span class="toc-text">2. Delve into the Erlang Cover coverage collection implementation mechanism</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2.1.-introduction-erlang-cover"><span class="toc-text">2.1. Introduction Erlang Cover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2.2.-erlang-code-coverage-collection-implementation-analysis"><span class="toc-text">2.2. Erlang code coverage collection implementation analysis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2.3.-learn-about-beam-file-format"><span class="toc-text">2.3. Learn about BEAM File Format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2.4.-elixir-source-code-compilation-process"><span class="toc-text">2.4. Elixir source code compilation process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2.5.-cover-on-the-fly-instrumentation-implementation"><span class="toc-text">2.5. Cover On-The-Fly Instrumentation Implementation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3.-elixir-application-runtime-coverage-collection-example"><span class="toc-text">3. Elixir Application runtime coverage collection example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4.-continuous-runtime-coverage-collection-solution-for-large-scale-elixir/erlang-microservice-clusters"><span class="toc-text">4. Continuous runtime coverage collection solution for large-scale Elixir&#x2F;Erlang Microservice clusters</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#references"><span class="toc-text">References</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>å‚ä¸è®¨è®º</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":"","officialHosts":["localhost","shansan.top","shansan.cn","yeshan333.github.io"],"encoded":""};
  const ctx = {
    date_suffix: {
      just: `åˆšåˆš`,
      min: `åˆ†é’Ÿå‰`,
      hour: `å°æ—¶å‰`,
      day: `å¤©å‰`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] è¶…æ—¶:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('è¯·æ±‚è¶…æ—¶');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('å“åº”å¤±è´¥');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] é”™è¯¯:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
    // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode å½“å‰æ¨¡å¼ dark or light
  // utils.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // utils.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // é€šçŸ¥ LazyLoad æ›´æ–°
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: è¿™ä¼šå¯¼è‡´æ— æ³•ä½¿ç”¨ preferred_color_scheme ä»¥å¤–çš„ä¸»é¢˜
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼`,
      dark: `åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼`,
      auto: `åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.getElementById('artalk_container');
  util.viewportLazyload(el, load_artalk, false);

  function load_artalk() {
    if (!el) return;
    utils.css('https://unpkg.com/artalk@2.9.1/dist/Artalk.css');
    utils.js('https://unpkg.com/artalk@2.9.1/dist/Artalk.js', {defer: true}).then(function () {
      // ç›‘å¬ Artalk äº‹ä»¶
      // FIXME: Artalkå¼€å¯äº†æ‡’åŠ è½½ä¼šå¯¼è‡´è¯„è®ºè¾“å…¥é¢„è§ˆæ¡†é‡Œçš„å›¾ä¹Ÿå˜æˆdata-srcï¼Œå¯¼è‡´çœ‹ä¸åˆ°å›¾
      // Artalk.use((ctx) => {
      //   ctx.on('list-loaded', () => window.lazyLoadInstance?.update())
      // })
      const path = el.getAttribute('comment_id') ?? decodeURI(window.location.pathname);
      const artalk = Artalk.init({
        el: '#artalk_container',
        pageKey: path,
        pageTitle: 'the-solution-of-elixir-continuous-runtime-system-code-coverage-collection',
        server: 'https://artalk.shan333.cn/',
        site: 'ShanSan',
        darkMode: 'auto',
        
      });
    });
  }
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.16/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">

<script id="MathJax-script" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script defer type="text/javascript" src="https://gcore.jsdelivr.net/npm/mermaid@v9/dist/mermaid.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    var mermaid_config = {
      startOnLoad: true,
      theme:
        "auto" == "auto" &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "neutral",
      logLevel: 3,
      themeVariables: {
        darkMode: true
      },
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: "linear"
      },
      gantt: {
        axisFormat: "%Y/%m/%d"
      },
      sequence: {
        actorMargin: 50
      }
    }
    mermaid.initialize(mermaid_config);
  });
</script><script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->
<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"3N0nbmMoWnI9Z6Po",ck:"3N0nbmMoWnI9Z6Po"})</script>
</div></body></html>
